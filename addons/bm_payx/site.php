<?php /** * 扫码签到模块处理程序 * */defined('IN_IA') or exit('Access Denied');include 'HttpClient.class.php';define('FEYIN_HOST', 'my.feyin.net');define('FEYIN_PORT', 80);class bm_payxModuleSite extends WeModuleSite {    public $weid;    public function __construct() {        global $_W;        $this->weid = IMS_VERSION<0.6?$_W['weid']:$_W['uniacid'];    }	public function sendFreeMessage($msg,$key) {		$msg['reqTime'] = number_format(1000*time(), 0, '', '');		$content = $msg['memberCode'].$msg['msgDetail'].$msg['deviceNo'].$msg['msgNo'].$msg['reqTime'].$key;		$msg['securityCode'] = md5($content);		$msg['mode']=2;		//print_r('<pre>');print_r($msg);		//print_r('<pre>');print_r($content);				return $this->sendMessage($msg);	}	public function sendMessage($msgInfo) {		//print_r('<pre>');print_r($msgInfo);		//print_r('<pre>');print_r(FEYIN_HOST);		//$client = new HttpClient('my.feyin.net',80);		$client = new HttpClient(FEYIN_HOST,FEYIN_PORT);		//print_r('<pre>');print_r(FEYIN_PORT);		//print_r('<pre>');print_r($client['accept']);		if(!$client->post('/api/sendMsg',$msgInfo)){ //提交失败			return 'faild';		}		else{			return $client->getContent();		}	}			public function testSendFreeMessage($membercode,$feyinkey,$deviceno,$msgDetail){		$msgNo = time()+1;		/*		 自由格式的打印内容		*/		$freeMessage = array(			'memberCode'=>$membercode, 			'msgDetail'=>$msgDetail,			'deviceNo'=>$deviceno, 			'msgNo'=>$msgNo,		);		//print_r('<pre>');print_r($freeMessage);		//print_r('<pre>');print_r($feyinkey);		echo $this->sendFreeMessage($freeMessage,$feyinkey);		return $msgNo;	}	public function doWebReport(){		global $_GPC, $_W;		checklogin();		/*		$sql = 'SELECT `key`,`secret` FROM ' . tablename('account_wechats') . ' WHERE `uniacid`=:uniacid';		$row = pdo_fetchall($sql, array(':uniacid' => $_W['uniacid']));				print_r('<pre>');print_r($row);		print_r('<pre>');print_r($_W);exit;		*/		if ($_W['user']['groupid']==6) {			message("请联系管理员授权，谢谢！",referer(),'error');		}		$op = !empty($_GPC['op']) ? $_GPC['op'] : 'detail';		$rid = intval($_GPC['id']);		$reply = pdo_fetch("SELECT * FROM ".tablename('bm_payx_reply')." WHERE rid = :rid ORDER BY `id` DESC", array(':rid' => $rid));		$condition = '';		//print_r('<pre>');print_r($reply);exit;		if (!empty($_GPC['store'])) {			$condition .= " AND b.store like '%{$_GPC['store']}%' ";		}		if (!empty($_GPC['starttime'])) {			$starttime=$_GPC['starttime'];			//print_r('<pre>');print_r(strtotime($_GPC['starttime']));			$condition .= " and dateline>=" . strtotime($starttime). " ";		}		if (!empty($_GPC['endtime'])) {			$endtime=$_GPC['endtime'];			//print_r('<pre>');print_r(strtotime($_GPC['endtime']));exit;			$condition .= " and dateline<=" . strtotime($endtime). " ";		}		/*		if (!empty($_GPC['startdate'])) {			$condition .= " and date_format(FROM_UNIXTIME(a.dateline),'%Y-%m-%d')>='" . $_GPC['startdate']. "' ";		}		if (!empty($_GPC['enddate'])) {			$condition .= " and date_format(FROM_UNIXTIME(a.dateline),'%Y-%m-%d')<='" . $_GPC['enddate']. "' ";		}		*/		if ($op=='detail') {			$pindex = max(1, intval($_GPC['page']));			$psize = 20;						$list = pdo_fetchall("SELECT a.*,b.store as storename,b.payrate FROM ".tablename('bm_payx_payed')." a inner join " .tablename('bm_payx_reply'). " b on a.rid=b.rid and b.weid='{$_W['uniacid']}' WHERE 1=1 $condition ORDER BY id DESC LIMIT ".($pindex - 1) * $psize.','.$psize);			//print_r('<pre>');print_r($list);exit;			$total = pdo_fetchcolumn('SELECT COUNT(*) FROM ' . tablename('bm_payx_payed') . " a inner join " .tablename('bm_payx_reply'). " b on a.rid=b.rid and b.weid='{$_W['uniacid']}' WHERE 1=1 $condition ");			$totalmoney = pdo_fetchcolumn('SELECT sum(a.qrmoney) FROM ' . tablename('bm_payx_payed') . " a inner join " .tablename('bm_payx_reply'). " b on a.rid=b.rid and b.weid='{$_W['uniacid']}' WHERE 1=1 $condition ");			$totalsuccess = pdo_fetchcolumn('SELECT COUNT(*) FROM ' . tablename('bm_payx_payed') . " a inner join " .tablename('bm_payx_reply'). " b on a.rid=b.rid and b.weid='{$_W['uniacid']}' WHERE 1=1 $condition and status>0");			$totalsuccessmoney = pdo_fetchcolumn('SELECT sum(a.qrmoney) FROM ' . tablename('bm_payx_payed') . " a inner join " .tablename('bm_payx_reply'). " b on a.rid=b.rid and b.weid='{$_W['uniacid']}' WHERE 1=1 $condition and status>0");			$pager = pagination($total, $pindex, $psize);		}		include $this->template('report');	}			public function doWebStore(){		global $_W,$_GPC;		load()->model('reply');		load()->func('tpl');		$weid=$_W['uniacid'];		$op = !empty($_GPC['op'])?$_GPC['op']:'display';		//print_r('<pre>');print_r($_W);exit;		$id = $_GPC['id'];		$mid = $_GPC['mid'];		if ($op == 'post') {			if (!empty($_GPC['mid'])) {				$item = pdo_fetch("SELECT * FROM ".tablename('bm_payx_store')." WHERE id='{$_GPC['mid']}' order by id desc");			}			$data = array(				'weid'          => $weid,				'store'         => $_GPC['store'],				'createtime'    => TIMESTAMP,			);			if ($_W['ispost']) {				if (empty($_GPC['mid'])) {					pdo_insert('bm_payx_store',$data);				}else{					//print_r($data);exit;					pdo_update('bm_payx_store',$data,array("id" => $_GPC['mid']));				}				message("更新成功",referer(),'success');			}		}elseif( $op == 'display'){			$sql="SELECT * FROM ".tablename('bm_payx_store')." WHERE weid='{$weid}' order by id desc";			$list = pdo_fetchAll($sql);		}elseif( $op == 'delete'){			pdo_delete("bm_payx_store",array('id' => $_GPC['mid'] ));			message("删除成功",referer(),'success');		}		include $this->template('store');	}	    public function doWebdownload() {        require_once 'download.php';    }		public function doWebEmployee(){		global $_W,$_GPC;		load()->model('reply');		load()->func('tpl');		$weid=$_W['uniacid'];		$op = !empty($_GPC['op'])?$_GPC['op']:'display';		//print_r('<pre>');print_r($_W);exit;		$id = $_GPC['id'];		$mid = $_GPC['mid'];		if ($op == 'post') {			if (!empty($_GPC['mid'])) {				$item = pdo_fetch("SELECT * FROM ".tablename('bm_payx_employee')." WHERE id='{$_GPC['mid']}' order by id desc");			}			$data = array(				'rid'           => $id,				'weid'          => $weid,				'name'          => $_GPC['name'],				'from_user'     => $_GPC['from_user'],				'createtime'    => TIMESTAMP,			);			if ($_W['ispost']) {				if (empty($_GPC['mid'])) {					pdo_insert('bm_payx_employee',$data);				}else{					//print_r($data);exit;					pdo_update('bm_payx_employee',$data,array("id" => $_GPC['mid']));				}				message("更新成功",referer(),'success');			}		}elseif( $op == 'display'){			$sql="SELECT * FROM ".tablename('bm_payx_employee')." WHERE weid='{$weid}' and rid='{$id}' order by id desc";			$list = pdo_fetchAll($sql);		}elseif( $op == 'delete'){			pdo_delete("bm_payx_employee",array('id' => $_GPC['mid'] ));			message("删除成功",referer(),'success');		}		include $this->template('employee');	}	public function doWebMember(){		global $_W,$_GPC;		load()->model('reply');		load()->func('tpl');		$weid=$_W['uniacid'];		$op = !empty($_GPC['op'])?$_GPC['op']:'display';		//print_r('<pre>');print_r($_W);exit;		$id = $_GPC['id'];		$mid = $_GPC['mid'];		$members = pdo_fetchall("SELECT * FROM ".tablename('mc_groups')." WHERE uniacid = :weid ORDER BY `groupid` DESC", array(':weid' => $weid));		if ($op == 'post') {			if (!empty($_GPC['mid'])) {				$item = pdo_fetch("SELECT * FROM ".tablename('bm_payx_member')." WHERE id='{$_GPC['mid']}' order by id desc");			}			$member = pdo_fetch("SELECT * FROM ".tablename('mc_groups')." WHERE uniacid = :weid and title = :title ORDER BY `groupid` DESC", array(':weid' => $weid , ':title' => $_GPC['membername']));			$data = array(				'rid'           => $id,				'weid'          => $weid,				'membername'    => $_GPC['membername'],				'memberid'      => $member['groupid'],				'memberrate'    => $_GPC['memberrate'],				'createtime'    => TIMESTAMP,			);			if ($_W['ispost']) {				if (empty($_GPC['mid'])) {					pdo_insert('bm_payx_member',$data);				}else{					//print_r($data);exit;					pdo_update('bm_payx_member',$data,array("id" => $_GPC['mid']));				}				message("更新成功",referer(),'success');			}		}elseif( $op == 'display'){			$sql="SELECT * FROM ".tablename('bm_payx_member')." WHERE weid='{$weid}' and rid='{$id}' order by id desc";			$list = pdo_fetchAll($sql);		}elseif( $op == 'delete'){			pdo_delete("bm_payx_member",array('id' => $_GPC['mid'] ));			message("删除成功",referer(),'success');		}		include $this->template('member');	}	public function doWebCard(){		global $_W,$_GPC;		load()->model('reply');		load()->func('tpl');		$weid=$_W['uniacid'];		$op = !empty($_GPC['op'])?$_GPC['op']:'display';		//print_r('<pre>');print_r($_W);exit;		$id = $_GPC['id'];		$mid = $_GPC['mid'];		if ($op == 'post') {			if (!empty($_GPC['mid'])) {				$item = pdo_fetch("SELECT * FROM ".tablename('bm_payx_card')." WHERE id='{$_GPC['mid']}' order by id desc");			}			$data = array(				'rid'        => $id,				'weid'       => $weid,				'cardline'   => $_GPC['cardline'],				'cardid'     => $_GPC['cardid'],				'cardname'   => $_GPC['cardname'],				'createtime' => TIMESTAMP,			);			if ($_W['ispost']) {				if (empty($_GPC['mid'])) {					pdo_insert('bm_payx_card',$data);				}else{					//print_r($data);exit;					pdo_update('bm_payx_card',$data,array("id" => $_GPC['mid']));				}				message("更新成功",referer(),'success');			}		}elseif( $op == 'display'){			$sql="SELECT * FROM ".tablename('bm_payx_card')." WHERE weid='{$weid}' and rid='{$id}' order by id desc";			$list = pdo_fetchAll($sql);		}elseif( $op == 'delete'){			pdo_delete("bm_payx_card",array('id' => $_GPC['mid'] ));			message("删除成功",referer(),'success');		}		include $this->template('card');	}	public function doWebRed(){		global $_W,$_GPC;		load()->model('reply');		load()->func('tpl');		$weid=$_W['uniacid'];		$op = !empty($_GPC['op'])?$_GPC['op']:'display';		//print_r('<pre>');print_r($_W);exit;		$id = $_GPC['id'];		$mid = $_GPC['mid'];		if ($op == 'post') {			if (!empty($_GPC['mid'])) {				$item = pdo_fetch("SELECT * FROM ".tablename('bm_payx_red')." WHERE id='{$_GPC['mid']}' order by id desc");			}			$data = array(				'rid'        => $id,				'weid'       => $weid,				'redline'    => $_GPC['redline'],				'redlow'     => $_GPC['redlow'],				'redhigh'    => $_GPC['redhigh'],				'redrate'    => $_GPC['redrate'],				'createtime' => TIMESTAMP,			);			if ($_W['ispost']) {				if (empty($_GPC['mid'])) {					pdo_insert('bm_payx_red',$data);				}else{					//print_r($data);exit;					pdo_update('bm_payx_red',$data,array("id" => $_GPC['mid']));				}				message("更新成功",referer(),'success');			}		}elseif( $op == 'display'){			$sql="SELECT * FROM ".tablename('bm_payx_red')." WHERE weid='{$weid}' and rid='{$id}' order by id desc";			$list = pdo_fetchAll($sql);		}elseif( $op == 'delete'){			pdo_delete("bm_payx_red",array('id' => $_GPC['mid'] ));			message("删除成功",referer(),'success');		}		include $this->template('red');	}		public function doWebRecord(){		global $_GPC, $_W;		checklogin();		load()->func('tpl');		$rid = intval($_GPC['id']);		$condition = '';		if (!empty($_GPC['username'])) {			$condition .= " AND username like '%{$_GPC['username']}%' ";		}		if (!empty($_GPC['sign_time'])) {			$condition .= " AND sign_time = '%{$_GPC['username']}%' ";		}		if (empty($starttime) || empty($endtime)) {			$starttime = strtotime('-1 month');			$endtime = TIMESTAMP;		}		if (!empty($_GPC['time'])) {			$starttime = strtotime($_GPC['time']['start']);			$endtime = strtotime($_GPC['time']['end']) + 86399;			$condition .= " AND sign_time >= '{$starttime}' AND sign_time <= '{$endtime}' ";			//print_r('abc');print_r($condition);exit;		}		$pindex = max(1, intval($_GPC['page']));		$psize = 20;		$list = pdo_fetchall("SELECT * FROM ".tablename('bm_payx_record')." WHERE rid = '$rid' $condition ORDER BY id DESC LIMIT ".($pindex - 1) * $psize.','.$psize);		$total = pdo_fetchcolumn('SELECT COUNT(*) FROM ' . tablename('bm_payx_record') . " WHERE rid = '$rid' ");		$pager = pagination($total, $pindex, $psize);		$memberlist = pdo_fetchall("SELECT distinct fromuser FROM ".tablename('bm_payx_record')."  WHERE rid = '$rid' ");		$membertotal = count($memberlist);		include $this->template('record');	}	public function doWebWinner(){		global $_GPC, $_W;		checklogin();		$rid = intval($_GPC['id']);		$condition = '';		if (!empty($_GPC['username'])) {			$condition .= " AND username like '%{$_GPC['username']}%' ";		}		$pindex = max(1, intval($_GPC['page']));		$psize = 20;		$list = pdo_fetchall("SELECT * FROM ".tablename('bm_payx_winner')." WHERE rid = '$rid' $condition ORDER BY id DESC LIMIT ".($pindex - 1) * $psize.','.$psize);		$total = pdo_fetchcolumn('SELECT COUNT(*) FROM ' . tablename('bm_payx_winner') . " WHERE rid = '$rid' ");		$pager = pagination($total, $pindex, $psize);		$memberlist = pdo_fetchall("SELECT distinct from_user FROM ".tablename('bm_payx_winner')."  WHERE rid = '$rid' ");		$membertotal = count($memberlist);		include $this->template('winner');	}		public function doWebPlay(){		global $_GPC, $_W;		checklogin();		$rid = intval($_GPC['id']);		$reply = pdo_fetch("SELECT * FROM ".tablename('bm_payx_reply')." WHERE rid = :rid ORDER BY `id` DESC", array(':rid' => $rid));		//$list = pdo_fetchall("SELECT id, content, from_user, type, createtime FROM ".tablename('wxwall_message')." WHERE rid = '{$wall['rid']}' AND isshow = '2' AND from_user <> '' ORDER BY createtime DESC");		if ($reply['qrtype'] == 0) {			$list = pdo_fetchall("SELECT id,username as content,fromuser as from_user,'text' as type,sign_time as createtime,username as nickname,avatar FROM ".tablename('bm_payx_record')." WHERE rid = '$rid' and play_status=0 ORDER BY id DESC");				} else {			$list = pdo_fetchall("SELECT id,username as content,fromuser as from_user,'text' as type,dateline as createtime,username as nickname,avatar FROM ".tablename('bm_payx_payed')." WHERE rid = '$rid' and play_status=0 and status=1 ORDER BY id DESC");				}		//$this->formatMsg($list);		//print_r('<pre>');print_r($list);exit;		include $this->template('play');	}		public function doWebAjaxsubmit() {				global $_GPC, $_W;		$rid = intval($_GPC['rid']);		$reply = pdo_fetch("SELECT * FROM ".tablename('bm_payx_reply')." WHERE rid = :rid ORDER BY `id` DESC", array(':rid' => $rid));		$result=$reply['play_status'];		echo $result;	}	public function doWebAddwinner() {		global $_GPC, $_W;		checklogin();		$rid = intval($_GPC['id']);		$reply = pdo_fetch("SELECT * FROM ".tablename('bm_payx_reply')." WHERE rid = :rid ORDER BY `id` DESC", array(':rid' => $rid));		//$list = pdo_fetchall("SELECT id, content, from_user, type, createtime FROM ".tablename('wxwall_message')." WHERE rid = '{$wall['rid']}' AND isshow = '2' AND from_user <> '' ORDER BY createtime DESC");		if ($reply['qrtype'] == 0) {			$message = pdo_fetch("SELECT * FROM ".tablename('bm_payx_record')." WHERE id = :id LIMIT 1", array(':id'=>intval($_GPC['mid'])));		} else {			$message = pdo_fetch("SELECT * FROM ".tablename('bm_payx_payed')." WHERE id = :id LIMIT 1", array(':id'=>intval($_GPC['mid'])));		}				if (empty($message)) {			message('抱歉，参数不正确！', '', 'error');		}		$data = array(			'rid' => $message['rid'],			'from_user' => $message['fromuser'],			'dateline' => TIMESTAMP,			'username' => $message['username'],			'avatar' => $message['avatar'],			'status' => 0,		);		pdo_insert('bm_payx_winner', $data);		if ($reply['qrtype'] == 0) {			pdo_update('bm_payx_record', array('play_status' => 1 , 'play_time' => TIMESTAMP) , array('id' => intval($_GPC['mid'])));		} else {			pdo_update('bm_payx_payed', array('play_status' => 1 , 'play_time' => TIMESTAMP) , array('id' => intval($_GPC['mid'])));		}					//发送模版消息			//print_r('<pre>');print_r($payed['status']);			//if ($payed['status']==0) {				$url=$reply['urly'];				$template = array('touser' => $message['fromuser'],								'template_id' => $reply['templateid'],								//'url' => $_W['siteroot'].$this->createMobileUrl('index', array()),								'url' => $url,								'topcolor' => "#7B68EE",								'data' => array('first'	=> array('value' => urlencode('恭喜您在'.$_W['account']['name'].'的大屏幕活动中得奖！'),																 'color' => "#743A3A",																  ),											  'keyword1' => array('value' => urlencode($reply['awaremethod']),																 'color' => "#FF0000",																  ),											  'keyword2' 	=> array('value' => urlencode($reply['awaretime']),																 'color' => "#0000FF",																  ),											  'remark' 	=> array('value' => urlencode("感谢您的参与！"),																 'color' => "#008000",																  ),											  )								);				//$appid = 'wx15a1f53f11f8c79e';				//$appsecret = 'd0a28b42361f580e5208181d01430ba6';				//$sql = 'SELECT `key`,`secret` FROM ' . tablename('account_wechats') . ' WHERE `acid`=:acid';				//$row = pdo_fetch($sql, array(':acid' => $_W['account']['uniacid']));				//$sql = 'SELECT `key`,`secret` FROM ' . tablename('account_wechats') . ' WHERE `acid`=:acid';				//$row = pdo_fetch($sql, array(':acid' => $_W['account']['uniacid']));				//$appid = $row['key'];				//$appsecret = $row['secret'];				$appid = $_W['account']['key'];				$appsecret = $_W['account']['secret'];								//print_r('<pre>');print_r($_W);print_r('|+|+|');print_r($appid);print_r('|+|+|');print_r($appsecret);				$url = 'https://api.weixin.qq.com/cgi-bin/token?grant_type=client_credential&appid='.$appid.'&secret='.$appsecret;				//print_r('|+|+|');print_r($url);print_r('|+|+|');print_r($this->kjSetting['template']);exit;				$res = $this->http_request($url);				$result = json_decode($res, true);				$access_token = $result["access_token"];				$lasttime = time();				//print_r('<pre>');print_r($reply);print_r('|+|+|');print_r($template);print_r('|+|+|');print_r($url);print_r('|+|+|');print_r($result);				$x=$this->send_template_message(urldecode(json_encode($template)),$access_token);				$result=array(					'errcode' => $x['errcode'],					'errmsg' => $x['errmsg'],					'msgid' => $x['msgid'],				);				//message($result, '', 'success');												//print_r('<pre>');				//print_r('|+11+|');print_r($x);				message('', '', 'success');	}	    //https请求（支持GET和POST）    private function http_request($url, $data = null)    {        $curl = curl_init();        curl_setopt($curl, CURLOPT_URL, $url);        curl_setopt($curl, CURLOPT_SSL_VERIFYPEER, FALSE);        curl_setopt($curl, CURLOPT_SSL_VERIFYHOST, FALSE);        if (!empty($data)){            curl_setopt($curl, CURLOPT_POST, 1);            curl_setopt($curl, CURLOPT_POSTFIELDS, $data);        }        curl_setopt($curl, CURLOPT_RETURNTRANSFER, 1);        $output = curl_exec($curl);        curl_close($curl);        return $output;    }		    //发送模版消息	private function send_template_message($data,$access_token)    {		$url = "https://api.weixin.qq.com/cgi-bin/message/template/send?access_token=".$access_token;        $res = $this->http_request($url, $data);        return json_decode($res, true);	}			public function doWebGetaware() {		global $_GPC, $_W;		checklogin();		$rid = intval($_GPC['rid']);		$condition = '';		if (!empty($_GPC['username'])) {			$condition .= " AND username like '%{$_GPC['username']}%' ";		}		//print_r($_GPC['status']);		if (!empty($_GPC['id'])) {			$id = intval($_GPC['id']);			//print_r($_GPC['id']);			pdo_update('bm_payx_winner', array('status' => intval($_GPC['status'])), array('id' => $id));			//message('操作成功！', $this->createWebUrl('awardlist', array('do' => 'awardlist', 'name' => 'bm_floor', 'id' => $id, 'page' => $_GPC['page'], 'state' => '')));		}				$pindex = max(1, intval($_GPC['page']));		$psize = 20;		$list = pdo_fetchall("SELECT * FROM ".tablename('bm_payx_winner')." WHERE rid = '$rid' $condition ORDER BY id DESC LIMIT ".($pindex - 1) * $psize.','.$psize);		$total = pdo_fetchcolumn('SELECT COUNT(*) FROM ' . tablename('bm_payx_winner') . " WHERE rid = '$rid' ");		$pager = pagination($total, $pindex, $psize);		$memberlist = pdo_fetchall("SELECT distinct from_user FROM ".tablename('bm_payx_winner')."  WHERE rid = '$rid' ");		$membertotal = count($memberlist);		include $this->template('winner');		}		public function doWebPayed(){		global $_GPC, $_W;		checklogin();		$rid = intval($_GPC['id']);		$iid = intval($_GPC['iid']);		$op = trim($_GPC['op']);		$condition = '';		if (!empty($_GPC['username'])) {			$condition .= " AND username like '%{$_GPC['username']}%' ";		}		if (!empty($_GPC['store'])) {			$condition .= " AND store like '%{$_GPC['store']}%' ";		}		if (!empty($_GPC['name'])) {			$condition .= " AND name like '%{$_GPC['name']}%' ";		}		/*		if (!empty($_GPC['startdate'])) {			$condition .= " and date_format(FROM_UNIXTIME(dateline),'%Y-%m-%d')>='" . $_GPC['startdate']. "' ";		}		if (!empty($_GPC['enddate'])) {			$condition .= " and date_format(FROM_UNIXTIME(dateline),'%Y-%m-%d')<='" . $_GPC['enddate']. "' ";		}		*/		if (!empty($_GPC['starttime'])) {			$starttime=$_GPC['starttime'];			//print_r('<pre>');print_r(strtotime($_GPC['starttime']));			$condition .= " and dateline>=" . strtotime($starttime). " ";		}		if (!empty($_GPC['endtime'])) {			$endtime=$_GPC['endtime'];			//print_r('<pre>');print_r(strtotime($_GPC['endtime']));exit;			$condition .= " and dateline<=" . strtotime($endtime). " ";		}		if ($op=='used') {			pdo_update('bm_payx_payed',array("status" => 2),array("id" => $iid));		} elseif ($op=='payed') {			pdo_update('bm_payx_payed',array("status" => 1),array("id" => $iid));		} elseif ($op=='unpayed') {			pdo_update('bm_payx_payed',array("status" => 0),array("id" => $iid));		} elseif ($op=='get') {			pdo_update('bm_payx_payed',array("getstatus" => 1),array("id" => $iid));		} elseif ($op=='unget') {			pdo_update('bm_payx_payed',array("getstatus" => 0),array("id" => $iid));		} elseif ($op=='delete') {			pdo_delete('bm_payx_payed', array('id' => $iid));		}		$pindex = max(1, intval($_GPC['page']));		$psize = 20;		$list = pdo_fetchall("SELECT * FROM ".tablename('bm_payx_payed')." WHERE rid = '$rid' $condition ORDER BY id DESC LIMIT ".($pindex - 1) * $psize.','.$psize);		$total = pdo_fetchcolumn('SELECT COUNT(*) FROM ' . tablename('bm_payx_payed') . " WHERE rid = '$rid' $condition");		$totalsuccess = pdo_fetchcolumn('SELECT COUNT(*) FROM ' . tablename('bm_payx_payed') . " WHERE rid = '$rid' and status>0 $condition");		$pager = pagination($total, $pindex, $psize);		//$memberlist = pdo_fetchall("SELECT distinct from_user FROM ".tablename('bm_payx_payed')."  WHERE rid = '$rid' ");		//$membertotal = count($memberlist);		include $this->template('payed');	}			public function doMobileSign() {		global $_W, $_GPC;		load()->model('mc');		$rid = trim($_GPC['rid']);		$reply = pdo_fetch("SELECT * FROM ".tablename('bm_payx_reply')." WHERE rid = :rid ORDER BY `id` DESC", array(':rid' => $rid));		$useragent = addslashes($_SERVER['HTTP_USER_AGENT']);        if (strpos($useragent, 'MicroMessenger') === false && strpos($useragent, 'Windows Phone') === false) {			message('非法访问，请通过微信打开！');			die();        }				if (time() > strtotime($reply['endtime'])) {			if (empty($reply['memo2'])) {				$msg='对不起，活动已经于' . $reply['endtime'] . '结束，感谢您的参与！！！';			} else {				$msg=$reply['memo2'];			}			message($msg,$reply['url2'],'success');		}		if (time() < strtotime($reply['starttime'])) {			if (empty($reply['memo1'])) {				$msg='对不起，活动将于' . $reply['starttime'] . '开始，敬请期待！！！';			} else {				$msg=$reply['memo1'];			}			message($msg,$reply['url1'],'success');		}		if (empty($_W['fans']['nickname'])) {			mc_oauth_userinfo();		}		if ($reply['pictype'] == 1) {			if ((empty($_W['fans']['follow'])) || ($_W['fans']['follow'] == 0)){				header("Location: " . $reply['urlx']); 				//确保重定向后，后续代码不会被执行 				exit;			}		}		$from_user = $_W['fans']['openid'];		$rec = pdo_fetch("select * from " . tablename('bm_payx_record') . " where rid= " . $rid . " and fromuser= '{$from_user}' order by sign_time desc");		if(!empty($rec)){			$Date_1=date("Y-m-d",time());			$Date_2=date("Y-m-d",$rec['sign_time']);			$Date_List_a1=explode("-",$Date_1);			$Date_List_a2=explode("-",$Date_2);			$d1=mktime(0,0,0,$Date_List_a1[1],$Date_List_a1[2],$Date_List_a1[0]);			$d2=mktime(0,0,0,$Date_List_a2[1],$Date_List_a2[2],$Date_List_a2[0]);			$Days=round(($d1-$d2)/3600/24);			if ($Days == 0) {				$msg='感谢您的参与，每个人每天只可以签到一次哦！！！';				message($msg,$reply['urly'],'success');			}		}				$insert = array(			'rid' => $rid,			'fromuser' => $from_user,			'username' => $_W['fans']['nickname'],			'avatar' => $_W['fans']['tag']['avatar'],			'sign_time' => $_W['timestamp'],			'credit' => $reply['n'],			'store' => $reply['store'],		);		pdo_insert('bm_payx_record', $insert);		$user = fans_search($from_user);		$sql_member = "SELECT a.uid FROM " . tablename('mc_mapping_fans') . " a inner join " . tablename('mc_members') . " b on a.uid=b.uid WHERE b.uniacid='{$_W['uniacid']}' and a.openid='{$from_user}'";		$uid = pdo_fetchcolumn($sql_member);		$updatememo = mc_credit_update($uid , 'credit1' , intval($reply['n']) , array('0' => $uid, '1' => '扫码签到送积分' ));		$user = fans_search($from_user);		message($reply['memo'],$reply['urly'],'success');	}		public function doMobilePay() {		global $_W,$_GPC;		$rid = trim($_GPC['rid']);		$setting = uni_setting($_W['uniacid'], array('payment'));		//print_r('<pre>');print_r($setting);exit;		$reply = pdo_fetch("SELECT * FROM ".tablename('bm_payx_reply')." WHERE rid = :rid ORDER BY `id` DESC", array(':rid' => $rid));		//print_r('<pre>');print_r($_W);exit;		if (!empty($reply['headbg'])) {			$headbg=$_W['attachurl'] . "/" .$reply['headbg'];		} else {			$headbg="http://img2.bitautoimg.com/uimg/mbt2014/cheyitong/images/user-center-bg.jpg";		}		$useragent = addslashes($_SERVER['HTTP_USER_AGENT']);        if (strpos($useragent, 'MicroMessenger') === false && strpos($useragent, 'Windows Phone') === false) {			message('非法访问，请通过微信打开！');			die();        }				if (time() > strtotime($reply['endtime'])) {			if (empty($reply['memo2'])) {				$msg='对不起，活动已经于' . $reply['endtime'] . '结束，感谢您的参与！！！';			} else {				$msg=$reply['memo2'];			}			message($msg,$reply['url2'],'success');		}		if (time() < strtotime($reply['starttime'])) {			if (empty($reply['memo1'])) {				$msg='对不起，活动将于' . $reply['starttime'] . '开始，敬请期待！！！';			} else {				$msg=$reply['memo1'];			}			message($msg,$reply['url1'],'success');		}				if (empty($_W['fans']['nickname'])) {			mc_oauth_userinfo();		}		//print_r('<pre>');print_r($_W['fans']);exit;		//if (!empty($_W['fans']['follow'])){ echo '已关注'; } else { echo '未关注'; }exit;		//print_r('|+x+|');print_r($_W['fans']['follow']);print_r('|+x+|');		//print_r($reply['pictype']);print_r('|+x+|');		if ($reply['pictype'] == 1) {			if ((empty($_W['fans']['follow'])) || ($_W['fans']['follow'] == 0)){				//print_r($reply['urlx']);				header("Location: " . $reply['urlx']); 				//确保重定向后，后续代码不会被执行 				exit;			}		}		$op = trim($_GPC['op']);		$from_user = $_W['fans']['openid'];		$qrtype = $reply['qrtype'];		$qrits = $reply['qrinput'];		if (checksubmit('submit')) {			$member = pdo_fetch("SELECT membername,memberrate FROM ".tablename('bm_payx_member')." a inner join ".tablename('mc_members')." b on a.memberid=b.groupid inner join ".tablename('mc_mapping_fans')." c on c.uid=b.uid WHERE c.uniacid = :weid and c.openid = :openid and a.rid = :rid ORDER BY `id` DESC", array(':rid' => $reply['rid'], ':weid' => $reply['weid'], ':openid' => $from_user));			if (($reply['member']==0)||(empty($member))) {				$qrmoney = $_GPC['qrmoney'];				$realmoney = $_GPC['qrmoney'];				$member['membername']='---';				$member['memberrate']='---';			} else {				$realmoney = $_GPC['qrmoney'];				$qrmoney = round($_GPC['qrmoney']*$member[memberrate]/100,2);			}			//print_r('<pre>');print_r($qrmoney);			//print_r('<pre>');print_r($realmoney);			//print_r('<pre>');print_r($reply);			//print_r('<pre>');print_r($member);exit;			if ($op == 'post') {				if ($reply['openid']==$from_user) {					pdo_update('bm_payx_reply',array("qrmoney" => $qrmoney),array("rid" => $rid));					message('二维码收款金额修改为'.$qrmoney.'元！',$this->createMobileUrl('pay',array('rid' => $rid,'from_user' => $from_user)),'success');				} else {										if ($qrmoney < 0.01) {						message('支付金额错误，请重新录入！',$this->createMobileUrl('pay',array('rid' => $rid,'from_user' => $from_user)),'error');					}					if ($reply['ntype']==0) {						$credit1n=$reply['n'];					} else {						$credit1n=round($reply['n']*$qrmoney/100,0);					}										$data = array(						'rid' => $rid,						'dateline' => TIMESTAMP,						'clientOrderId' => TIMESTAMP.random(6, 1),						'qrmoney' => $qrmoney,						'status' => 0,						'fromuser' => $from_user,						'username' => $_W['fans']['nickname'],						'avatar' => $_W['fans']['tag']['avatar'],						'credit' => $credit1n,						'paycode' => random(6, 1),						'store' => $reply['store'],						'realmoney' => $realmoney,						'membername' => $member['membername'],						'memberrate' => $member['memberrate'],					);					//print_r('<pre>');print_r($insert);exit;					pdo_insert('bm_payx_payed', $data);										//构造支付请求中的参数					$params = array(						'tid' => $data['clientOrderId'],      //充值模块中的订单号，此号码用于业务模块中区分订单，交易的识别码						'ordersn' => $data['clientOrderId'],  //收银台中显示的订单号						'title' => '扫码支付',          //收银台中显示的标题						'fee' => $data['qrmoney'],      //收银台中显示需要支付的金额,只能大于 0						'user' => $from_user,     //付款用户, 付款的用户名(选填项)					);					//print_r('<pre>');print_r($params);exit;					//调用pay方法					$this->pay($params);					exit;				}			}		}				if($reply['qrmoney'] <= 0) {			message('支付错误, 金额小于0');		}		if (!empty($reply['logo'])){			$qrpicurl = $_W['attachurl'] . $reply['logo'];		} else {			$qrpicurl = $_W['attachurl'] . $reply['qrcode'];		}				if($reply['qrinput'] == 1) {			include $this->template('show');		} else {			include $this->template('show');			//message('正在提交订单，请稍候',$this->createmobileurl('pay_exec',array('rid' => $rid,'from_user' => $from_user)),'success');		}	}	public function payResult($params) {		global $_W,$_GPC;		load()->model('mc');		//一些业务代码		//根据参数params中的result来判断支付是否成功		/*Array(    [weid] => 1    [uniacid] => 1    [result] => success    [type] => wechat    [from] => return    [tid] => 1459555890068262    [uniontid] => 2016040208113300004856254467    [user] => 729    [fee] => 0.01    [tag] => Array        (            [transaction_id] => 4009292001201604024473867466        )    [is_usecard] => 0    [card_type] => 0    [card_fee] => 0.01    [card_id] => )				*/		//print_r('<pre>');print_r($params);		$payed = pdo_fetch("select * from " . tablename('bm_payx_payed') . " where clientOrderId = '{$params['tid']}' and qrmoney=".$params['fee']);		//print_r('<pre>');print_r($payed);exit;		if (!empty($payed)) {			//print_r('<pre>');print_r($payed);			$reply = pdo_fetch("SELECT * FROM " . tablename('bm_payx_reply') . " WHERE rid = :rid ORDER BY `id` DESC", array(':rid' => $payed['rid']));			$employees = pdo_fetchall("SELECT * FROM " . tablename('bm_payx_employee') . " WHERE weid = :weid and rid = :rid ORDER BY `id` DESC", array(':weid' => $reply['weid'] , ':rid' => $payed['rid']));			//print_r('<pre>');print_r($reply);exit;			if ($params['result'] == 'success' && $params['type'] == 'alipay' && $params['from'] == 'notify' && $payed['paytype'] ==2 ) {				$url=$_W['siteroot'].'app/'.$this->createMobileUrl('payok',array('cid' => $payed['clientOrderId']));				header("Location: " . $url);				exit;			}			if ($params['result'] == 'success' && $params['type'] == 'alipay' && $params['from'] == 'notify' && $payed['paytype'] <2 ) {				pdo_update('bm_payx_payed',array("status" => 1 , "paytype" => 2 , "paytime" => TIMESTAMP),array("clientOrderId" => $params['tid']));				$msgDetail='<Font# Bold=0 Width=1 Height=2>　　欢迎使用微信支付</Font#>'."\n"."\n";				     				$msgDetail=$msgDetail.'----------------------------'."\n"."\n";				$msgDetail=$msgDetail.'商户名称:'.$reply['title']."\n";				$msgDetail=$msgDetail.'商户电话:'.$reply['tel']."\n";				$msgDetail=$msgDetail.'订单编号:'.$params['tid']."\n";				$msgDetail=$msgDetail.'消费金额:'.$payed['qrmoney']."元\n";				$msgDetail=$msgDetail.'消费时间:'.date('Y-m-d H:i:s', TIMESTAMP)."\n"."\n";				$msgDetail=$msgDetail.'----------------------------'."\n";				$msgDetail=$msgDetail."\n";				$msgDetail=$msgDetail.'客户签名:'."\n"."\n"."\n";				$msgDetail=$msgDetail.'<Font# Bold=0 Width=1 Height=2>客户至上 欢迎下次惠顾！</Font#>'."\n";				$sms=$this->testSendFreeMessage($reply['membercode'],$reply['feyinkey'],$reply['deviceno'],$msgDetail);								//--模板消息开始				$urlrpt=$_W['siteroot'].'app/'.$this->createMobileUrl('paycheck',array('cid' => $payed['clientOrderId']));				$template = array('touser' => $reply['openid'],								'template_id' => $reply['templateid1'],								//'url' => $_W['siteroot'].$this->createMobileUrl('index', array()),								'url' => $urlrpt,								'topcolor' => "#7B68EE",								'data' => array('first'	=> array('value' => urlencode($reply['title'].'有客户使用支付宝完成扫码支付！'),																 'color' => "#743A3A",																  ),											  'keyword1' => array('value' => urlencode($payed['clientOrderId']),																 'color' => "#FF0000",																  ),											  'keyword2' 	=> array('value' => urlencode(date('Y-m-d H:i:s',time())),																 'color' => "#0000FF",																  ),											  'keyword3' 	=> array('value' => urlencode($payed['qrmoney']),																 'color' => "#0000FF",																  ),															  											  'remark' 	=> array('value' => urlencode("付款码：".$payed['paycode']."，客户昵称：" . $payed['username']. "，点击详情查看账单！"),																 'color' => "#008000",																  ),											  )								);							$sql = 'SELECT `key`,`secret` FROM ' . tablename('account_wechats') . ' WHERE `uniacid`=:uniacid';				$row = pdo_fetch($sql, array(':uniacid' => $reply['weid']));				$appid = $row['key'];				$appsecret = $row['secret'];				$url = 'https://api.weixin.qq.com/cgi-bin/token?grant_type=client_credential&appid='.$appid.'&secret='.$appsecret;				$res = $this->http_request($url);				$result = json_decode($res, true);				$access_token = $result["access_token"];				$lasttime = time();				$x=$this->send_template_message(urldecode(json_encode($template)),$access_token);				foreach ($employees as $employee) {					$template = array('touser' => $employee['from_user'],									'template_id' => $reply['templateid1'],									//'url' => $_W['siteroot'].$this->createMobileUrl('index', array()),									'url' => $urlrpt,									'topcolor' => "#7B68EE",									'data' => array('first'	=> array('value' => urlencode($reply['title'].'有客户使用支付宝完成扫码支付！'),																	 'color' => "#743A3A",																	  ),												  'keyword1' => array('value' => urlencode($payed['clientOrderId']),																	 'color' => "#FF0000",																	  ),												  'keyword2' 	=> array('value' => urlencode(date('Y-m-d H:i:s',time())),																	 'color' => "#0000FF",																	  ),												  'keyword3' 	=> array('value' => urlencode($payed['qrmoney']),																	 'color' => "#0000FF",																	  ),															  												  'remark' 	=> array('value' => urlencode("付款码：".$payed['paycode']."，客户昵称：" . $payed['username']. "，点击详情查看账单！"),																	 'color' => "#008000",																	  ),												  )									);							$x=$this->send_template_message(urldecode(json_encode($template)),$access_token);				}			//--模板消息结束			//--红包开始				if ($reply['red']==1) {					$reds = pdo_fetch("select * from " . tablename('bm_payx_red') . " where rid = ".$payed['rid']." and redline <= ".$payed['qrmoney']." order by redline desc limit 1");					//print_r('<pre>');print_r($reds);					if (!empty($reds)) {						if ($payed[qrmoney]>=$reds['redline']) {							$rate=intval($reds['redrate']);							$ratex=100-$rate;							$prize_arr = array(								'0' => array('id'=>1,'prize'=>'o','v'=>$rate),								'1' => array('id'=>2,'prize'=>'x','v'=>$ratex),							);							$arr=array();							foreach ($prize_arr as $key => $val) {								$arr[$val['id']] = $val['v'];							}							$ridx = $this->get_rand($arr); //根据概率获取奖项id							$res=array();							$res['yes'] = $prize_arr[$ridx-1]['prize']; //中奖项							unset($prize_arr[$ridx-1]); //将中奖项从数组中剔除，剩下未中奖项 							shuffle($prize_arr); //打乱数组顺序 							for($i=0;$i<count($prize_arr);$i++){								$pr[] = $prize_arr[$i]['prize'];							}							$res['no'] = $pr;							if ($res['yes']=='o') {								if ($reds['redlow'] == $reds['redhigh']) {									$red = $reds['redlow'];								} else {									$red = $reds['redlow'] + mt_rand() / mt_getrandmax() * ($reds['redhigh'] - $reds['redlow']);									$red = round($red,2);								}								$url='https://api.mch.weixin.qq.com/mmpaymkttransfers/sendredpack';								$pars = array();								$pars['nonce_str'] =random(32);								$pars['mch_billno'] =$_W['cache']['unisetting:'.$reply['weid']]['payment']['wechat']['mchid'].date("Ymd").random(10,1);									$pars['mch_id'] = $_W['cache']['unisetting:'.$reply['weid']]['payment']['wechat']['mchid'];								$pars['wxappid'] = $appid;								$pars['send_name'] =$reply['title'];								$pars['re_openid'] =$payed['fromuser'];								$pars['total_amount'] = $red * 100;								$pars['total_num'] =1;								$pars['wishing'] ='感谢您的光临！送上红包，敬请请笑纳！';								$pars['client_ip'] ='203.195.157.41';								$pars['act_name'] =$reply['title'];								$pars['remark'] ="扫码支付送红包,订单号为".$payed['clientOrderId'];												ksort($pars, SORT_STRING);								$string1 = '';								foreach ($pars as $k => $v) {									$string1 .= "{$k}={$v}&";								}								$string1 .= "key=" .$_W['cache']['unisetting:'.$reply['weid']]['payment']['wechat']['apikey'];								$pars['sign'] = strtoupper(md5($string1));								$xml = array2xml($pars);								$extras = array();								$extras['CURLOPT_CAINFO']  = dirname(dirname(dirname(__FILE__))) . '/addons/bm_payx/cert/rootca.pem' . $reply['weid'];								$extras['CURLOPT_SSLCERT'] = dirname(dirname(dirname(__FILE__))) . '/addons/bm_payx/cert/apiclient_cert.pem' . $reply['weid'];								$extras['CURLOPT_SSLKEY']  = dirname(dirname(dirname(__FILE__))) . '/addons/bm_payx/cert/apiclient_key.pem' . $reply['weid'];								$procResult = null;								load()->func('communication');								$resp = ihttp_request($url, $xml, $extras);								if (is_error($resp)) {									$procResult = $resp;								} else {									$arr=json_decode(json_encode((array) simplexml_load_string($resp['content'])), true);									$xml = '<?xml version="1.0" encoding="utf-8"?>' . $resp['content'];									$dom = new \DOMDocument();									if ($dom->loadXML($xml)) {										$xpath = new \DOMXPath($dom);										$code = $xpath->evaluate('string(//xml/return_code)');										$ret = $xpath->evaluate('string(//xml/result_code)');										if (strtolower($code) == 'success' && strtolower($ret) == 'success') {											$procResult =  array('errno'=>0,'error'=>'success');										} else {											$error = $xpath->evaluate('string(//xml/err_code_des)');											$procResult = array('errno'=>-2,'error'=>$error);										}									} else {										$procResult = array('errno'=>-1,'error'=>'未知错误');													}								}								//print_r('<pre>');print_r('|+红包结果+|');print_r($procResult);								pdo_update('bm_payx_payed',array("red" => $red , "redtime" => TIMESTAMP , "redstatus" => $procResult['errno'] , "redmemo" => $procResult['error']),array("clientOrderId" => $params['tid']));							} else {								$red=0;							}											}					}				}				//--红包结束				//--卡券开始				if ($reply['card']==1) {					$reds = pdo_fetch("select * from " . tablename('bm_payx_card') . " where rid = ".$payed['rid']." and cardline <= ".$payed['qrmoney']." order by cardline desc limit 1");					if (!empty($reds)) {						if ($payed[qrmoney]>=$reds['cardline']) {							$data=array(								'touser' => $payed['fromuser'],								'wxcard' => array('card_id' => $reds['cardid']),								'msgtype' => 'wxcard',							);							load()->func('communication');							$postUrl='https://api.weixin.qq.com/cgi-bin/message/mass/preview?access_token='.$access_token;							$json_data = json_encode($data); 							$result = ihttp_post($postUrl ,urldecode($json_data));							$procResult = @json_decode($result['content'], true);							$insert = array (								'cardid' => $reds['cardid'],								'cardname' => $reds['cardname'],								'cardtime' => TIMESTAMP,								'cardstatus' => $procResult['errcode'],								'cardmemo' => $procResult['errmsg'],							);							pdo_update('bm_payx_payed',$insert,array("clientOrderId" => $params['tid']));						}					}				}				//--卡券结束				//--企业支付开始				if ($reply['payout']==1) {					$setting = uni_setting($_W['uniacid'], array('payment'));						$wechat = $setting['payment']['wechat'];									$url = 'https://api.mch.weixin.qq.com/mmpaymkttransfers/promotion/transfers';					$pars = array();					$pars['mch_appid'] = $appid;					$pars['mchid'] = $_W['cache']['unisetting:'.$reply['weid']]['payment']['wechat']['mchid'];					$pars['nonce_str'] = random(32);					$pars['partner_trade_no'] = random(10) . date('Ymd') . random(3);					$pars['openid'] = $reply['openid'];					$pars['check_name'] = "NO_CHECK";					$pars['re_user_name'] = "{$reply['title']}";					$pars['amount'] = $payed['qrmoney']*(100-$reply['payrate']);					$pars['desc'] = '扫码收款自动提现' . $payed['qrmoney'] . '元';					$pars['spbill_create_ip'] = '203.195.157.41';					ksort($pars, SORT_STRING);					$string1 = '';					foreach ($pars as $k => $v) {						$string1.= "{$k}={$v}&";					}					$string1.= "key=" . $_W['cache']['unisetting:'.$reply['weid']]['payment']['wechat']['apikey'];					$pars['sign'] = strtoupper(md5($string1));					$xml = '<xml>';					foreach ($pars as $k => $v) {						$xml.= "<{$k}>{$v}</{$k}>";					}					$xml.= '</xml>';					$extras = array();					$extras['CURLOPT_CAINFO']  = dirname(dirname(dirname(__FILE__))) . '/addons/bm_payx/cert/rootca.pem' . $reply['weid'];					$extras['CURLOPT_SSLCERT'] = dirname(dirname(dirname(__FILE__))) . '/addons/bm_payx/cert/apiclient_cert.pem' . $reply['weid'];					$extras['CURLOPT_SSLKEY']  = dirname(dirname(dirname(__FILE__))) . '/addons/bm_payx/cert/apiclient_key.pem' . $reply['weid'];					$procResult = null;					load()->func('communication');					$resp = ihttp_request($url, $xml, $extras);									if(is_error($resp)) {						$procResult = $resp;					} else {						$xml = '<?xml version="1.0" encoding="utf-8"?>' . $resp['content'];						$dom = new DOMDocument();						if($dom->loadXML($xml)) {							$xpath = new DOMXPath($dom);							$code = $xpath->evaluate('string(//xml/return_code)');							$ret = $xpath->evaluate('string(//xml/result_code)');							if(strtolower($code) == 'success' && strtolower($ret) == 'success') {								$procResult = true;							} else {								$error = $xpath->evaluate('string(//xml/err_code_des)');								$procResult = error(-2, $error);							}						} else {							$procResult = error(-1, 'error response');						}					}					$getmoney=$pars['amount']/100;					if ($procResult==1) {						pdo_update('bm_payx_payed',array("getmoney" => $getmoney,"getinfo" => 'success',"gettime" => TIMESTAMP,"getstatus"=>1),array("clientOrderId" => $params['tid']));					} else {						pdo_update('bm_payx_payed',array("getmoney" => $getmoney,"getinfo" => $procResult['message'],"gettime" => TIMESTAMP,"getstatus"=>0),array("clientOrderId" => $params['tid']));					}				}				//企业支付结束							$fansuid =  pdo_fetchcolumn("select uid from " . tablename('mc_mapping_fans') . " where openid='{$payed['fromuser']}'");				if ($reply['ntype']==0) {					$credit1n=$reply['n'];				} else {					$credit1n=round($reply['n']*$payed['qrmoney']/100,0);				}				$updatememo = mc_credit_update($fansuid , 'credit1' , intval($credit1n) , array('0' => $fansuid, '1' => '扫码支付送积分' ));				/*				$fanscredit1 =  pdo_fetchcolumn("select credit1 from " . tablename('mc_members') . " where uid='{$fansuid}'");				if ($reply['ntype']==0) {					$credit1x=$fanscredit1+$reply['n'];				} else {					$credit1x=$fanscredit1+round($reply['n']*$payed['qrmoney']/100,0);				}				pdo_update('mc_members',array("credit1" => $credit1x),array("uid" => $fansuid));				*/				$url=$_W['siteroot'].'app/'.$this->createMobileUrl('payok',array('cid' => $payed['clientOrderId']));				$template = array('touser' => $payed['fromuser'],								'template_id' => $reply['templateid1'],								'url' => $url,								'topcolor' => "#7B68EE",								'data' => array('first'	=> array('value' => urlencode('感谢您使用'.$reply['title'].'扫码支付！'),																 'color' => "#743A3A",																  ),											  'keyword1' => array('value' => urlencode($payed['clientOrderId']),																 'color' => "#FF0000",																  ),											  'keyword2' 	=> array('value' => urlencode(date('Y-m-d H:i:s',time())),																 'color' => "#0000FF",																  ),											  'keyword3' 	=> array('value' => urlencode($payed['qrmoney']),																 'color' => "#0000FF",																  ),															  											  'remark' 	=> array('value' => urlencode("付款码：".$payed['paycode']."，点击详情查看账单！"),																 'color' => "#008000",																  ),											  )								);						$x=$this->send_template_message(urldecode(json_encode($template)),$access_token);					}						if ($params['result'] == 'success' && $params['type'] == 'credit' && $params['from'] == 'return') {				pdo_update('bm_payx_payed',array("status" => 1 , "paytype" => 1 , "paytime" => TIMESTAMP),array("clientOrderId" => $params['tid']));				$msgDetail='<Font# Bold=0 Width=1 Height=2>　　欢迎使用微信支付</Font#>'."\n"."\n";				     				$msgDetail=$msgDetail.'----------------------------'."\n"."\n";				$msgDetail=$msgDetail.'商户名称:'.$reply['title']."\n";				$msgDetail=$msgDetail.'商户电话:'.$reply['tel']."\n";				$msgDetail=$msgDetail.'订单编号:'.$params['tid']."\n";				$msgDetail=$msgDetail.'消费金额:'.$payed['qrmoney']."元\n";				$msgDetail=$msgDetail.'消费时间:'.date('Y-m-d H:i:s', TIMESTAMP)."\n"."\n";				$msgDetail=$msgDetail.'----------------------------'."\n";				$msgDetail=$msgDetail."\n";				$msgDetail=$msgDetail.'客户签名:'."\n"."\n"."\n";				$msgDetail=$msgDetail.'<Font# Bold=0 Width=1 Height=2>客户至上 欢迎下次惠顾！</Font#>'."\n";				$sms=$this->testSendFreeMessage($reply['membercode'],$reply['feyinkey'],$reply['deviceno'],$msgDetail);				//--模板消息开始				$urlrpt=$_W['siteroot'].'app/'.$this->createMobileUrl('paycheck',array('cid' => $payed['clientOrderId']));				$template = array('touser' => $reply['openid'],								'template_id' => $reply['templateid1'],								'url' => $urlrpt,								'topcolor' => "#7B68EE",								'data' => array('first'	=> array('value' => urlencode($_W['account']['name'].'有客户使用余额完成扫码支付！'),																 'color' => "#743A3A",																  ),											  'keyword1' => array('value' => urlencode($payed['clientOrderId']),																 'color' => "#FF0000",																  ),											  'keyword2' 	=> array('value' => urlencode(date('Y-m-d H:i:s',time())),																 'color' => "#0000FF",																  ),											  'keyword3' 	=> array('value' => urlencode($payed['qrmoney']),																 'color' => "#0000FF",																  ),															  											  'remark' 	=> array('value' => urlencode("付款码：".$payed['paycode']."，客户昵称：" . $payed['username']. "，点击详情查看账单！"),																 'color' => "#008000",																  ),											  )								);							$sql = 'SELECT `key`,`secret` FROM ' . tablename('account_wechats') . ' WHERE `uniacid`=:uniacid';				$row = pdo_fetch($sql, array(':uniacid' => $reply['weid']));				$appid = $row['key'];				$appsecret = $row['secret'];				$url = 'https://api.weixin.qq.com/cgi-bin/token?grant_type=client_credential&appid='.$appid.'&secret='.$appsecret;				$res = $this->http_request($url);				$result = json_decode($res, true);				$access_token = $result["access_token"];				$lasttime = time();				$x=$this->send_template_message(urldecode(json_encode($template)),$access_token);								foreach ($employees as $employee) {					$template = array('touser' => $employee['from_user'],									'template_id' => $reply['templateid1'],									'url' => $urlrpt,									'topcolor' => "#7B68EE",									'data' => array('first'	=> array('value' => urlencode($_W['account']['name'].'有客户使用余额完成扫码支付！'),																	 'color' => "#743A3A",																	  ),												  'keyword1' => array('value' => urlencode($payed['clientOrderId']),																	 'color' => "#FF0000",																	  ),												  'keyword2' 	=> array('value' => urlencode(date('Y-m-d H:i:s',time())),																	 'color' => "#0000FF",																	  ),												  'keyword3' 	=> array('value' => urlencode($payed['qrmoney']),																	 'color' => "#0000FF",																	  ),															  												  'remark' 	=> array('value' => urlencode("付款码：".$payed['paycode']."，客户昵称：" . $payed['username']. "，点击详情查看账单！"),																	 'color' => "#008000",																	  ),												  )									);							$x=$this->send_template_message(urldecode(json_encode($template)),$access_token);				}						//--模板消息结束				//--红包开始				if ($reply['red']==1) {					$reds = pdo_fetch("select * from " . tablename('bm_payx_red') . " where rid = ".$payed['rid']." and redline <= ".$payed['qrmoney']." order by redline desc limit 1");					if (!empty($reds)) {						if ($payed[qrmoney]>=$reds['redline']) {							$rate=intval($reds['redrate']);							$ratex=100-$rate;							$prize_arr = array(								'0' => array('id'=>1,'prize'=>'o','v'=>$rate),								'1' => array('id'=>2,'prize'=>'x','v'=>$ratex),							);							$arr=array();							foreach ($prize_arr as $key => $val) {								$arr[$val['id']] = $val['v'];							}							$ridx = $this->get_rand($arr); //根据概率获取奖项id							$res=array();							$res['yes'] = $prize_arr[$ridx-1]['prize']; //中奖项							unset($prize_arr[$ridx-1]); //将中奖项从数组中剔除，剩下未中奖项 							shuffle($prize_arr); //打乱数组顺序 							for($i=0;$i<count($prize_arr);$i++){								$pr[] = $prize_arr[$i]['prize'];							}							$res['no'] = $pr;							if ($res['yes']=='o') {								if ($reds['redlow'] == $reds['redhigh']) {									$red = $reds['redlow'];								} else {									$red = $reds['redlow'] + mt_rand() / mt_getrandmax() * ($reds['redhigh'] - $reds['redlow']);									$red = round($red,2);								}																$setting = uni_setting($_W['uniacid'], array('payment'));									$wechat = $setting['payment']['wechat'];											$url='https://api.mch.weixin.qq.com/mmpaymkttransfers/sendredpack';								$pars = array();								$pars['nonce_str'] =random(32);								$pars['mch_billno'] =$wechat['mchid'].date("Ymd").random(10,1);									$pars['mch_id']=$wechat['mchid'];								$pars['wxappid'] =$_W['account']['key'];								$pars['send_name'] =$_W['account']['name'];								$pars['re_openid'] =$_W['fans']['openid'];								$pars['total_amount'] = $red * 100;								$pars['total_num'] =1;								$pars['wishing'] ='感谢您的光临！送上红包，敬请请笑纳！';								$pars['client_ip'] ='203.195.157.41';								$pars['act_name'] =$reply['title'];								$pars['remark'] ="扫码支付送红包,订单号为".$payed['clientOrderId'];												ksort($pars, SORT_STRING);								$string1 = '';								foreach ($pars as $k => $v) {									$string1 .= "{$k}={$v}&";								}								$string1 .= "key=" .$wechat['apikey'];								$pars['sign'] = strtoupper(md5($string1));								$xml = array2xml($pars);								$extras = array();								$extras['CURLOPT_CAINFO']  = dirname(dirname(dirname(__FILE__))) . '/addons/bm_payx/cert/rootca.pem' . $_W['uniacid'];								$extras['CURLOPT_SSLCERT'] = dirname(dirname(dirname(__FILE__))) . '/addons/bm_payx/cert/apiclient_cert.pem' . $_W['uniacid'];								$extras['CURLOPT_SSLKEY']  = dirname(dirname(dirname(__FILE__))) . '/addons/bm_payx/cert/apiclient_key.pem' . $_W['uniacid'];								$procResult = null;								load()->func('communication');								$resp = ihttp_request($url, $xml, $extras);								if (is_error($resp)) {									$procResult = $resp;								} else {									$arr=json_decode(json_encode((array) simplexml_load_string($resp['content'])), true);									$xml = '<?xml version="1.0" encoding="utf-8"?>' . $resp['content'];									$dom = new \DOMDocument();									if ($dom->loadXML($xml)) {										$xpath = new \DOMXPath($dom);										$code = $xpath->evaluate('string(//xml/return_code)');										$ret = $xpath->evaluate('string(//xml/result_code)');										if (strtolower($code) == 'success' && strtolower($ret) == 'success') {											$procResult =  array('errno'=>0,'error'=>'success');										} else {											$error = $xpath->evaluate('string(//xml/err_code_des)');											$procResult = array('errno'=>-2,'error'=>$error);										}									} else {										$procResult = array('errno'=>-1,'error'=>'未知错误');													}								}								pdo_update('bm_payx_payed',array("red" => $red , "redtime" => TIMESTAMP , "redstatus" => $procResult['errno'] , "redmemo" => $procResult['error']),array("clientOrderId" => $params['tid']));							} else {								$red=0;							}											}					}				}				//--红包结束				//--卡券开始				if ($reply['card']==1) {					$reds = pdo_fetch("select * from " . tablename('bm_payx_card') . " where rid = ".$payed['rid']." and cardline <= ".$payed['qrmoney']." order by cardline desc limit 1");					if (!empty($reds)) {						if ($payed[qrmoney]>=$reds['cardline']) {							$data=array(								'touser' => $_W['fans']['openid'],								'wxcard' => array('card_id' => $reds['cardid']),								'msgtype' => 'wxcard',							);							load()->func('communication');							$url = 'https://api.weixin.qq.com/cgi-bin/token?grant_type=client_credential&appid='.$_W['account']['key'].'&secret='.$_W['account']['secret'];							$ret = ihttp_get($url);							$auth = @json_decode($ret['content'], true);							$postUrl='https://api.weixin.qq.com/cgi-bin/message/mass/preview?access_token='.$auth['access_token'];							$json_data = json_encode($data); 							$result = ihttp_post($postUrl ,urldecode($json_data));							$procResult = @json_decode($result['content'], true);							$insert = array (								'cardid' => $reds['cardid'],								'cardname' => $reds['cardname'],								'cardtime' => TIMESTAMP,								'cardstatus' => $procResult['errcode'],								'cardmemo' => $procResult['errmsg'],							);							pdo_update('bm_payx_payed',$insert,array("clientOrderId" => $params['tid']));						}					}				}				//--卡券结束				//--企业支付开始				if ($reply['payout']==1) {					$setting = uni_setting($_W['uniacid'], array('payment'));						$wechat = $setting['payment']['wechat'];									$url = 'https://api.mch.weixin.qq.com/mmpaymkttransfers/promotion/transfers';					$pars = array();					$pars['mch_appid'] = $_W['account']['key'];					$pars['mchid'] = $wechat['mchid'];					$pars['nonce_str'] = random(32);					$pars['partner_trade_no'] = random(10) . date('Ymd') . random(3);					$pars['openid'] = $reply['openid'];					$pars['check_name'] = "NO_CHECK";					$pars['re_user_name'] = "{$reply['title']}";					$pars['amount'] = $payed['qrmoney']*(100-$reply['payrate']);					$pars['desc'] = '扫码收款自动提现' . $payed['qrmoney'] . '元';					$pars['spbill_create_ip'] = '203.195.157.41';					ksort($pars, SORT_STRING);					$string1 = '';					foreach ($pars as $k => $v) {						$string1.= "{$k}={$v}&";					}					$string1.= "key=" . $wechat['apikey'];					$pars['sign'] = strtoupper(md5($string1));					$xml = '<xml>';					foreach ($pars as $k => $v) {						$xml.= "<{$k}>{$v}</{$k}>";					}					$xml.= '</xml>';					$extras = array();					$extras['CURLOPT_CAINFO']  = dirname(dirname(dirname(__FILE__))) . '/addons/bm_payx/cert/rootca.pem' . $_W['uniacid'];					$extras['CURLOPT_SSLCERT'] = dirname(dirname(dirname(__FILE__))) . '/addons/bm_payx/cert/apiclient_cert.pem' . $_W['uniacid'];					$extras['CURLOPT_SSLKEY']  = dirname(dirname(dirname(__FILE__))) . '/addons/bm_payx/cert/apiclient_key.pem' . $_W['uniacid'];					$procResult = null;					load()->func('communication');					$resp = ihttp_request($url, $xml, $extras);									if(is_error($resp)) {						$procResult = $resp;					} else {						$xml = '<?xml version="1.0" encoding="utf-8"?>' . $resp['content'];						$dom = new DOMDocument();						if($dom->loadXML($xml)) {							$xpath = new DOMXPath($dom);							$code = $xpath->evaluate('string(//xml/return_code)');							$ret = $xpath->evaluate('string(//xml/result_code)');							if(strtolower($code) == 'success' && strtolower($ret) == 'success') {								$procResult = true;							} else {								$error = $xpath->evaluate('string(//xml/err_code_des)');								$procResult = error(-2, $error);							}						} else {							$procResult = error(-1, 'error response');						}					}					$getmoney=$pars['amount']/100;					if ($procResult==1) {						pdo_update('bm_payx_payed',array("getmoney" => $getmoney,"getinfo" => 'success',"gettime" => TIMESTAMP,"getstatus"=>1),array("clientOrderId" => $params['tid']));					} else {						pdo_update('bm_payx_payed',array("getmoney" => $getmoney,"getinfo" => $procResult['message'],"gettime" => TIMESTAMP,"getstatus"=>0),array("clientOrderId" => $params['tid']));					}				}				//企业支付结束				$fansuid =  pdo_fetchcolumn("select uid from " . tablename('mc_mapping_fans') . " where openid='{$payed['fromuser']}'");				if ($reply['ntype']==0) {					$credit1n=$reply['n'];				} else {					$credit1n=round($reply['n']*$payed['qrmoney']/100,0);				}				$updatememo = mc_credit_update($fansuid , 'credit1' , intval($credit1n) , array('0' => $fansuid, '1' => '扫码支付送积分' ));				$url=$_W['siteroot'].'app/'.$this->createMobileUrl('payok',array('cid' => $payed['clientOrderId']));				$template = array('touser' => $_W['fans']['openid'],								'template_id' => $reply['templateid1'],								'url' => $url,								'topcolor' => "#7B68EE",								'data' => array('first'	=> array('value' => urlencode('感谢您使用'.$_W['account']['name'].'扫码支付！'),																 'color' => "#743A3A",																  ),											  'keyword1' => array('value' => urlencode($payed['clientOrderId']),																 'color' => "#FF0000",																  ),											  'keyword2' 	=> array('value' => urlencode(date('Y-m-d H:i:s',time())),																 'color' => "#0000FF",																  ),											  'keyword3' 	=> array('value' => urlencode($payed['qrmoney']),																 'color' => "#0000FF",																  ),															  											  'remark' 	=> array('value' => urlencode("付款码：".$payed['paycode']."，点击详情查看账单！"),																 'color' => "#008000",																  ),											  )								);						$x=$this->send_template_message(urldecode(json_encode($template)),$access_token);									header("Location: " . $url);				exit;			}									if ($params['result'] == 'success' && $params['from'] == 'notify' && $payed['status']==0) {				//此处会处理一些微信支付成功的业务代码				pdo_update('bm_payx_payed',array("status" => 1 , "wxorderid" => $params['uniontid'] , "paytime" => TIMESTAMP),array("clientOrderId" => $params['tid']));				$msgDetail='<Font# Bold=0 Width=1 Height=2>　　欢迎使用微信支付</Font#>'."\n"."\n";				     				$msgDetail=$msgDetail.'----------------------------'."\n"."\n";				$msgDetail=$msgDetail.'商户名称:'.$reply['title']."\n";				$msgDetail=$msgDetail.'商户电话:'.$reply['tel']."\n";				$msgDetail=$msgDetail.'订单编号:'.$params['tid']."\n";				$msgDetail=$msgDetail.'消费金额:'.$payed['qrmoney']."元\n";				$msgDetail=$msgDetail.'消费时间:'.date('Y-m-d H:i:s', TIMESTAMP)."\n"."\n";				$msgDetail=$msgDetail.'----------------------------'."\n";				$msgDetail=$msgDetail."\n";				$msgDetail=$msgDetail.'客户签名:'."\n"."\n"."\n";				$msgDetail=$msgDetail.'<Font# Bold=0 Width=1 Height=2>客户至上 欢迎下次惠顾！</Font#>'."\n";				$sms=$this->testSendFreeMessage($reply['membercode'],$reply['feyinkey'],$reply['deviceno'],$msgDetail);				//--模板消息开始				$urlrpt=$_W['siteroot'].'app/'.$this->createMobileUrl('paycheck',array('cid' => $payed['clientOrderId']));				$template = array('touser' => $reply['openid'],								'template_id' => $reply['templateid1'],								//'url' => $_W['siteroot'].$this->createMobileUrl('index', array()),								'url' => $urlrpt,								'topcolor' => "#7B68EE",								'data' => array('first'	=> array('value' => urlencode($_W['account']['name'].'有客户完成扫码支付！'),																 'color' => "#743A3A",																  ),											  'keyword1' => array('value' => urlencode($payed['clientOrderId']),																 'color' => "#FF0000",																  ),											  'keyword2' 	=> array('value' => urlencode(date('Y-m-d H:i:s',time())),																 'color' => "#0000FF",																  ),											  'keyword3' 	=> array('value' => urlencode($payed['qrmoney']),																 'color' => "#0000FF",																  ),															  											  'remark' 	=> array('value' => urlencode("付款码：".$payed['paycode']."，客户昵称：" . $payed['username']. "，点击详情查看账单！"),																 'color' => "#008000",																  ),											  )								);							//print_r('<pre>');print_r($reply['templateid']);				//$sql = 'SELECT `key`,`secret` FROM ' . tablename('account_wechats') . ' WHERE `acid`=:acid';				//$row = pdo_fetch($sql, array(':acid' => $_W['account']['uniacid']));				//$appid = $row['key'];				//$appsecret = $row['secret'];				//$appid = $_W['account']['key'];				//$appsecret = $_W['account']['secret'];				$sql = 'SELECT `key`,`secret` FROM ' . tablename('account_wechats') . ' WHERE `uniacid`=:uniacid';				$row = pdo_fetch($sql, array(':uniacid' => $reply['weid']));				$appid = $row['key'];				$appsecret = $row['secret'];								//print_r('<pre>');print_r($_W);print_r('|+|+|');print_r($appid);print_r('|+|+|');print_r($appsecret);				$url = 'https://api.weixin.qq.com/cgi-bin/token?grant_type=client_credential&appid='.$appid.'&secret='.$appsecret;				//print_r('|+|+|');print_r($url);print_r('|+|+|');print_r($this->kjSetting['template']);//exit;				//pdo_update('bm_payx_payed',array("avatar" => $url),array("clientOrderId" => $params['tid']));				$res = $this->http_request($url);				$result = json_decode($res, true);				$access_token = $result["access_token"];				$lasttime = time();				$x=$this->send_template_message(urldecode(json_encode($template)),$access_token);				foreach ($employees as $employee) {					$template = array('touser' => $employee['from_user'],									'template_id' => $reply['templateid1'],									//'url' => $_W['siteroot'].$this->createMobileUrl('index', array()),									'url' => $urlrpt,									'topcolor' => "#7B68EE",									'data' => array('first'	=> array('value' => urlencode($_W['account']['name'].'有客户完成扫码支付！'),																	 'color' => "#743A3A",																	  ),												  'keyword1' => array('value' => urlencode($payed['clientOrderId']),																	 'color' => "#FF0000",																	  ),												  'keyword2' 	=> array('value' => urlencode(date('Y-m-d H:i:s',time())),																	 'color' => "#0000FF",																	  ),												  'keyword3' 	=> array('value' => urlencode($payed['qrmoney']),																	 'color' => "#0000FF",																	  ),															  												  'remark' 	=> array('value' => urlencode("付款码：".$payed['paycode']."，客户昵称：" . $payed['username']. "，点击详情查看账单！"),																	 'color' => "#008000",																	  ),												  )									);							$x=$this->send_template_message(urldecode(json_encode($template)),$access_token);				}				$fansuid =  pdo_fetchcolumn("select uid from " . tablename('mc_mapping_fans') . " where openid='{$payed['fromuser']}'");				if ($reply['ntype']==0) {					$credit1n=$reply['n'];				} else {					$credit1n=round($reply['n']*$payed['qrmoney']/100,0);				}				$updatememo = mc_credit_update($fansuid , 'credit1' , intval($credit1n) , array('0' => $fansuid, '1' => '扫码支付送积分' ));				/*				$fanscredit1 =  pdo_fetchcolumn("select credit1 from " . tablename('mc_members') . " where uid='{$fansuid}'");				if ($reply['ntype']==0) {					$credit1x=$fanscredit1+$reply['n'];				} else {					$credit1x=$fanscredit1+round($reply['n']*$payed['qrmoney']/100,0);				}				pdo_update('mc_members',array("credit1" => $credit1x),array("uid" => $fansuid));				*/				$url=$_W['siteroot'].'app/'.$this->createMobileUrl('payok',array('cid' => $payed['clientOrderId']));				$template = array('touser' => $payed['fromuser'],							'template_id' => $reply['templateid1'],							//'url' => $_W['siteroot'].$this->createMobileUrl('index', array()),							'url' => $url,							'topcolor' => "#7B68EE",							'data' => array('first'	=> array('value' => urlencode('感谢您使用'.$_W['account']['name'].'扫码支付！'),															 'color' => "#743A3A",															  ),										  'keyword1' => array('value' => urlencode($payed['clientOrderId']),															 'color' => "#FF0000",															  ),										  'keyword2' 	=> array('value' => urlencode(date('Y-m-d H:i:s',time())),															 'color' => "#0000FF",															  ),										  'keyword3' 	=> array('value' => urlencode($payed['qrmoney']),															 'color' => "#0000FF",															  ),															  										  'remark' 	=> array('value' => urlencode("付款码：".$payed['paycode']."，点击详情查看账单！"),															 'color' => "#008000",															  ),										  )							);						$x=$this->send_template_message(urldecode(json_encode($template)),$access_token);											//--模板消息结束				//--红包开始				if ($reply['red']==1) {					$reds = pdo_fetch("select * from " . tablename('bm_payx_red') . " where rid = ".$payed['rid']." and redline <= ".$payed['qrmoney']." order by redline desc limit 1");					if (!empty($reds)) {											if ($payed[qrmoney]>=$reds['redline']) {							$rate=intval($reds['redrate']);							$ratex=100-$rate;							$prize_arr = array(								'0' => array('id'=>1,'prize'=>'o','v'=>$rate),								'1' => array('id'=>2,'prize'=>'x','v'=>$ratex),							);							$arr=array();							foreach ($prize_arr as $key => $val) {								$arr[$val['id']] = $val['v'];							}							$ridx = $this->get_rand($arr); //根据概率获取奖项id							$res=array();							$res['yes'] = $prize_arr[$ridx-1]['prize']; //中奖项							unset($prize_arr[$ridx-1]); //将中奖项从数组中剔除，剩下未中奖项 							shuffle($prize_arr); //打乱数组顺序 							for($i=0;$i<count($prize_arr);$i++){								$pr[] = $prize_arr[$i]['prize'];							}							$res['no'] = $pr;							if ($res['yes']=='o') {								if ($reds['redlow'] == $reds['redhigh']) {									$red = $reds['redlow'];								} else {									$red = $reds['redlow'] + mt_rand() / mt_getrandmax() * ($reds['redhigh'] - $reds['redlow']);									$red = round($red,2);								}																$setting = uni_setting($_W['uniacid'], array('payment'));									$wechat = $setting['payment']['wechat'];											$url='https://api.mch.weixin.qq.com/mmpaymkttransfers/sendredpack';								$pars = array();								$pars['nonce_str'] =random(32);								$pars['mch_billno'] =$_W['cache']['unisetting:'.$reply['weid']]['payment']['wechat']['mchid'].date("Ymd").random(10,1);									$pars['mch_id'] = $_W['cache']['unisetting:'.$reply['weid']]['payment']['wechat']['mchid'];								$pars['wxappid'] = $appid;								$pars['send_name'] =$reply['title'];								$pars['re_openid'] =$payed['fromuser'];								$pars['total_amount'] = $red * 100;								$pars['total_num'] =1;								$pars['wishing'] ='感谢您的光临！送上红包，敬请请笑纳！';								$pars['client_ip'] ='203.195.157.41';								$pars['act_name'] =$reply['title'];								$pars['remark'] ="扫码支付送红包,订单号为".$payed['clientOrderId'];																		ksort($pars, SORT_STRING);								$string1 = '';								foreach ($pars as $k => $v) {									$string1 .= "{$k}={$v}&";								}								$string1 .= "key=" .$wechat['apikey'];								$pars['sign'] = strtoupper(md5($string1));								$xml = array2xml($pars);								$extras = array();								$extras['CURLOPT_CAINFO']  = dirname(dirname(dirname(__FILE__))) . '/addons/bm_payx/cert/rootca.pem' . $_W['uniacid'];								$extras['CURLOPT_SSLCERT'] = dirname(dirname(dirname(__FILE__))) . '/addons/bm_payx/cert/apiclient_cert.pem' . $_W['uniacid'];								$extras['CURLOPT_SSLKEY']  = dirname(dirname(dirname(__FILE__))) . '/addons/bm_payx/cert/apiclient_key.pem' . $_W['uniacid'];								$procResult = null;								load()->func('communication');								$resp = ihttp_request($url, $xml, $extras);								if (is_error($resp)) {									$procResult = $resp;								} else {									$arr=json_decode(json_encode((array) simplexml_load_string($resp['content'])), true);									$xml = '<?xml version="1.0" encoding="utf-8"?>' . $resp['content'];									$dom = new \DOMDocument();									if ($dom->loadXML($xml)) {										$xpath = new \DOMXPath($dom);										$code = $xpath->evaluate('string(//xml/return_code)');										$ret = $xpath->evaluate('string(//xml/result_code)');										if (strtolower($code) == 'success' && strtolower($ret) == 'success') {											$procResult =  array('errno'=>0,'error'=>'success');										} else {											$error = $xpath->evaluate('string(//xml/err_code_des)');											$procResult = array('errno'=>-2,'error'=>$error);										}									} else {										$procResult = array('errno'=>-1,'error'=>'未知错误');													}								}								pdo_update('bm_payx_payed',array("red" => $red , "redtime" => TIMESTAMP , "redstatus" => $procResult['errno'] , "redmemo" => $procResult['error']),array("clientOrderId" => $params['tid']));							} else {								$red=0;							}											}					}				}				//--红包结束				//--卡券开始				if ($reply['card']==1) {					$reds = pdo_fetch("select * from " . tablename('bm_payx_card') . " where rid = ".$payed['rid']." and cardline <= ".$payed['qrmoney']." order by cardline desc limit 1");					if (!empty($reds)) {											if ($payed[qrmoney]>=$reds['cardline']) {							$data=array(								'touser' => $payed['fromuser'],								'wxcard' => array('card_id' => $reds['cardid']),								'msgtype' => 'wxcard',							);															load()->func('communication');							$url = 'https://api.weixin.qq.com/cgi-bin/token?grant_type=client_credential&appid='.$_W['account']['key'].'&secret='.$_W['account']['secret'];							$ret = ihttp_get($url);							$auth = @json_decode($ret['content'], true);							$postUrl='https://api.weixin.qq.com/cgi-bin/message/mass/preview?access_token='.$auth['access_token'];							$json_data = json_encode($data); 							$result = ihttp_post($postUrl ,urldecode($json_data));							$procResult = @json_decode($result['content'], true);							$insert = array (								'cardid' => $reds['cardid'],								'cardname' => $reds['cardname'],								'cardtime' => TIMESTAMP,								'cardstatus' => $procResult['errcode'],								'cardmemo' => $procResult['errmsg'],							);							pdo_update('bm_payx_payed',$insert,array("clientOrderId" => $params['tid']));						}					}				}				//--卡券结束				//企业支付开始				if ($reply['payout']==1) {					$setting = uni_setting($_W['uniacid'], array('payment'));						$wechat = $setting['payment']['wechat'];									$url = 'https://api.mch.weixin.qq.com/mmpaymkttransfers/promotion/transfers';					$pars = array();					$pars['mch_appid'] = $appid;					$pars['mchid'] = $_W['cache']['unisetting:'.$reply['weid']]['payment']['wechat']['mchid'];					$pars['nonce_str'] = random(32);					$pars['partner_trade_no'] = random(10) . date('Ymd') . random(3);					$pars['openid'] = $reply['openid'];					$pars['check_name'] = "NO_CHECK";					$pars['re_user_name'] = "{$reply['title']}";					$pars['amount'] = $payed['qrmoney']*(100-$reply['payrate']);					$pars['desc'] = '扫码收款自动提现' . $payed['qrmoney'] . '元';					$pars['spbill_create_ip'] = '203.195.157.41';												ksort($pars, SORT_STRING);					$string1 = '';					foreach ($pars as $k => $v) {						$string1.= "{$k}={$v}&";					}					$string1.= "key=" . $wechat['apikey'];					$pars['sign'] = strtoupper(md5($string1));					$xml = '<xml>';					foreach ($pars as $k => $v) {						$xml.= "<{$k}>{$v}</{$k}>";					}					$xml.= '</xml>';					$extras = array();					$extras['CURLOPT_CAINFO']  = dirname(dirname(dirname(__FILE__))) . '/addons/bm_payx/cert/rootca.pem' . $_W['uniacid'];					$extras['CURLOPT_SSLCERT'] = dirname(dirname(dirname(__FILE__))) . '/addons/bm_payx/cert/apiclient_cert.pem' . $_W['uniacid'];					$extras['CURLOPT_SSLKEY']  = dirname(dirname(dirname(__FILE__))) . '/addons/bm_payx/cert/apiclient_key.pem' . $_W['uniacid'];					$procResult = null;					load()->func('communication');					$resp = ihttp_request($url, $xml, $extras);									if(is_error($resp)) {						$procResult = $resp;					} else {						$xml = '<?xml version="1.0" encoding="utf-8"?>' . $resp['content'];						$dom = new DOMDocument();						if($dom->loadXML($xml)) {							$xpath = new DOMXPath($dom);							$code = $xpath->evaluate('string(//xml/return_code)');							$ret = $xpath->evaluate('string(//xml/result_code)');							if(strtolower($code) == 'success' && strtolower($ret) == 'success') {								$procResult = true;							} else {								$error = $xpath->evaluate('string(//xml/err_code_des)');								$procResult = error(-2, $error);							}						} else {							$procResult = error(-1, 'error response');						}					}					//print_r('<pre>');print_r('|+支付结果+|');print_r($procResult);					$getmoney=$pars['amount']/100;					if ($procResult==1) {						pdo_update('bm_payx_payed',array("getmoney" => $getmoney,"getinfo" => 'success',"gettime" => TIMESTAMP,"getstatus"=>1),array("clientOrderId" => $params['tid']));					} else {						pdo_update('bm_payx_payed',array("getmoney" => $getmoney,"getinfo" => $procResult['message'],"gettime" => TIMESTAMP,"getstatus"=>0),array("clientOrderId" => $params['tid']));					}					//print_r('<pre>');print_r('OK');exit;				}				//企业支付结束											/*	'		北京订餐网欢迎您订购	条目         单价（元）    数量	------------------------------	番茄炒粉				 10.0          1	客家咸香鸡				 20.0          1	备注：请快点送货。	------------------------------	合计：30.0元 	送货地址：北京中关村科技大厦23楼	联系电话：1380017****	订购时间：2011-01-06 19:30:10	'				*/						//print_r($info[resultCode]);exit;			}			//因为支付完成通知有两种方式 notify，return,notify为后台通知,return为前台通知，需要给用户展示提示信息			//return做为通知是不稳定的，用户很可能直接关闭页面，所以状态变更以notify为准			//如果消息是用户直接返回（非通知），则提示一个付款成功			if ($params['from'] == 'return') {				if ($params['result'] == 'success' && $payed['status']==0) {					//print_r('<pre>');print_r($sms);exit;					pdo_update('bm_payx_payed',array("status" => 1 , "wxorderid" => $params['uniontid'] , "paytime" => TIMESTAMP),array("clientOrderId" => $params['tid']));					//此处会处理一些支付成功的业务代码					//print_r('<pre>');print_r($payed);exit;					//--模板消息开始					$urlrpt=$_W['siteroot'].'app/'.$this->createMobileUrl('paycheck',array('cid' => $payed['clientOrderId']));					$template = array('touser' => $reply['openid'],									'template_id' => $reply['templateid1'],									//'url' => $_W['siteroot'].$this->createMobileUrl('index', array()),									'url' => $urlrpt,									'topcolor' => "#7B68EE",									'data' => array('first'	=> array('value' => urlencode($_W['account']['name'].'有客户完成扫码支付！'),																	 'color' => "#743A3A",																	  ),												  'keyword1' => array('value' => urlencode($payed['clientOrderId']),																	 'color' => "#FF0000",																	  ),												  'keyword2' 	=> array('value' => urlencode(date('Y-m-d H:i:s',time())),																	 'color' => "#0000FF",																	  ),												  'keyword3' 	=> array('value' => urlencode($payed['qrmoney']),																	 'color' => "#0000FF",																	  ),															  												  'remark' 	=> array('value' => urlencode("付款码：".$payed['paycode']."，客户昵称：" . $_W['fans']['nickname']. "，点击详情查看账单！"),																	 'color' => "#008000",																	  ),												  )									);								//print_r('<pre>');print_r($reply['templateid']);					$sql = 'SELECT `key`,`secret` FROM ' . tablename('account_wechats') . ' WHERE `uniacid`=:uniacid';					$row = pdo_fetch($sql, array(':uniacid' => $reply['weid']));											$appid = $row['key'];					$appsecret = $row['secret'];					//print_r('<pre>');print_r($_W);print_r('|+|+|');print_r($appid);print_r('|+|+|');print_r($appsecret);					$url = 'https://api.weixin.qq.com/cgi-bin/token?grant_type=client_credential&appid='.$appid.'&secret='.$appsecret;					//print_r('|+|+|');print_r($url);print_r('|+|+|');print_r($this->kjSetting['template']);//exit;										$res = $this->http_request($url);					$result = json_decode($res, true);					$access_token = $result["access_token"];					$lasttime = time();					$x=$this->send_template_message(urldecode(json_encode($template)),$access_token);									foreach ($employees as $employee) {						$template = array('touser' => $employee['from_user'],										'template_id' => $reply['templateid1'],										//'url' => $_W['siteroot'].$this->createMobileUrl('index', array()),										'url' => $urlrpt,										'topcolor' => "#7B68EE",										'data' => array('first'	=> array('value' => urlencode($_W['account']['name'].'有客户完成扫码支付！'),																		 'color' => "#743A3A",																		  ),													  'keyword1' => array('value' => urlencode($payed['clientOrderId']),																		 'color' => "#FF0000",																		  ),													  'keyword2' 	=> array('value' => urlencode(date('Y-m-d H:i:s',time())),																		 'color' => "#0000FF",																		  ),													  'keyword3' 	=> array('value' => urlencode($payed['qrmoney']),																		 'color' => "#0000FF",																		  ),															  													  'remark' 	=> array('value' => urlencode("付款码：".$payed['paycode']."，客户昵称：" . $_W['fans']['nickname']. "，点击详情查看账单！"),																		 'color' => "#008000",																		  ),													  )										);								$x=$this->send_template_message(urldecode(json_encode($template)),$access_token);					}									//print_r('<pre>');print_r('|+2+|');print_r($x);exit;					//pdo_update('bm_payx_payed',array("status" => 1 , "paytime" => TIMESTAMP),array("clientOrderId" => $params['tid']));					//print_r($info[resultCode]);exit;					//$url = $reply['urly'];					//$url = $this->createMobileUrl('payok',array('rid' => $rid,'payid' => $payed['id']));					//--模板消息结束					//--红包开始					if ($reply['red']==1) {						$reds = pdo_fetch("select * from " . tablename('bm_payx_red') . " where rid = ".$payed['rid']." and redline <= ".$payed['qrmoney']." order by redline desc limit 1");						if (!empty($reds)) {												if ($payed[qrmoney]>=$reds['redline']) {								$rate=intval($reds['redrate']);								$ratex=100-$rate;								$prize_arr = array(									'0' => array('id'=>1,'prize'=>'o','v'=>$rate),									'1' => array('id'=>2,'prize'=>'x','v'=>$ratex),								);								//print_r('<pre>');print_r('|+prize_arr+|');print_r($prize_arr);								$arr=array();								foreach ($prize_arr as $key => $val) {									$arr[$val['id']] = $val['v'];								}								//print_r('<pre>');print_r('|+arr+|');print_r($arr);								$ridx = $this->get_rand($arr); //根据概率获取奖项id								//print_r('<pre>');print_r('|+ridx+|');print_r($ridx);								$res=array();								$res['yes'] = $prize_arr[$ridx-1]['prize']; //中奖项								unset($prize_arr[$ridx-1]); //将中奖项从数组中剔除，剩下未中奖项 								shuffle($prize_arr); //打乱数组顺序 								for($i=0;$i<count($prize_arr);$i++){									$pr[] = $prize_arr[$i]['prize'];								}								$res['no'] = $pr;								//print_r('<pre>');print_r('|+res+|');print_r($res);								if ($res['yes']=='o') {									if ($reds['redlow'] == $reds['redhigh']) {										$red = $reds['redlow'];									} else {										$red = $reds['redlow'] + mt_rand() / mt_getrandmax() * ($reds['redhigh'] - $reds['redlow']);										$red = round($red,2);									}																		$setting = uni_setting($_W['uniacid'], array('payment'));										$wechat = $setting['payment']['wechat'];												$url='https://api.mch.weixin.qq.com/mmpaymkttransfers/sendredpack';									$pars = array();									$pars['nonce_str'] =random(32);									$pars['mch_billno'] =$wechat['mchid'].date("Ymd").random(10,1);										$pars['mch_id']=$wechat['mchid'];									$pars['wxappid'] =$_W['account']['key'];									$pars['send_name'] =$_W['account']['name'];									$pars['re_openid'] =$_W['fans']['openid'];									$pars['total_amount'] = $red * 100;									$pars['total_num'] =1;									$pars['wishing'] ='感谢您的光临！送上红包，敬请请笑纳！';									$pars['client_ip'] ='203.195.157.41';									$pars['act_name'] =$reply['title'];									$pars['remark'] ="扫码支付送红包,订单号为".$payed['clientOrderId'];													//print_r('<pre>');print_r($pars);									ksort($pars, SORT_STRING);									$string1 = '';									foreach ($pars as $k => $v) {										$string1 .= "{$k}={$v}&";									}									$string1 .= "key=" .$wechat['apikey'];									//print_r('<pre>');print_r($string1);									$pars['sign'] = strtoupper(md5($string1));									//print_r('<pre>');print_r($pars);									$xml = array2xml($pars);									$extras = array();									$extras['CURLOPT_CAINFO']  = dirname(dirname(dirname(__FILE__))) . '/addons/bm_payx/cert/rootca.pem' . $_W['uniacid'];									$extras['CURLOPT_SSLCERT'] = dirname(dirname(dirname(__FILE__))) . '/addons/bm_payx/cert/apiclient_cert.pem' . $_W['uniacid'];									$extras['CURLOPT_SSLKEY']  = dirname(dirname(dirname(__FILE__))) . '/addons/bm_payx/cert/apiclient_key.pem' . $_W['uniacid'];									//print_r('<pre>');print_r($extras);exit;									$procResult = null;									load()->func('communication');									$resp = ihttp_request($url, $xml, $extras);									//return var_dump($resp);									//print_r('<pre>');print_r($resp);									//print_r('<pre>');print_r(var_dump($resp));exit;									if (is_error($resp)) {										$procResult = $resp;										//print_r('abc');print_r('<pre>');print_r($procResult);exit;									} else {										$arr=json_decode(json_encode((array) simplexml_load_string($resp['content'])), true);										//print_r('123');print_r('<pre>');print_r($arr);exit;										$xml = '<?xml version="1.0" encoding="utf-8"?>' . $resp['content'];										$dom = new \DOMDocument();										if ($dom->loadXML($xml)) {											$xpath = new \DOMXPath($dom);											$code = $xpath->evaluate('string(//xml/return_code)');											$ret = $xpath->evaluate('string(//xml/result_code)');											if (strtolower($code) == 'success' && strtolower($ret) == 'success') {												$procResult =  array('errno'=>0,'error'=>'success');											} else {												$error = $xpath->evaluate('string(//xml/err_code_des)');												$procResult = array('errno'=>-2,'error'=>$error);											}										} else {											$procResult = array('errno'=>-1,'error'=>'未知错误');														}									}									//print_r('<pre>');print_r('|+红包结果+|');print_r($procResult);exit;									pdo_update('bm_payx_payed',array("red" => $red , "redtime" => TIMESTAMP , "redstatus" => $procResult['errno'] , "redmemo" => $procResult['error']),array("clientOrderId" => $params['tid']));								} else {									$red=0;								}												}						}					}					//print_r('<pre>');print_r('|+red+|');print_r($red);exit;					//--红包结束					//--卡券开始					if ($reply['card']==1) {						$reds = pdo_fetch("select * from " . tablename('bm_payx_card') . " where rid = ".$payed['rid']." and cardline <= ".$payed['qrmoney']." order by cardline desc limit 1");						if (!empty($reds)) {												if ($payed[qrmoney]>=$reds['cardline']) {								$data=array(									'touser' => $_W['fans']['openid'],									'wxcard' => array('card_id' => $reds['cardid']),									'msgtype' => 'wxcard',								);								load()->func('communication');								$url = 'https://api.weixin.qq.com/cgi-bin/token?grant_type=client_credential&appid='.$_W['account']['key'].'&secret='.$_W['account']['secret'];								$ret = ihttp_get($url);								$auth = @json_decode($ret['content'], true);								$postUrl='https://api.weixin.qq.com/cgi-bin/message/mass/preview?access_token='.$auth['access_token'];								//print_r('<pre>');print_r($postUrl);								$json_data = json_encode($data); 								//message($json_data ,'','error');								$result = ihttp_post($postUrl ,urldecode($json_data));								//print_r('<pre>');print_r($result);								$procResult = @json_decode($result['content'], true);								//print_r('<pre>');print_r($procResult);exit;								$insert = array (									'cardid' => $reds['cardid'],									'cardname' => $reds['cardname'],									'cardtime' => TIMESTAMP,									'cardstatus' => $procResult['errcode'],									'cardmemo' => $procResult['errmsg'],								);								//print_r($insert);exit;								pdo_update('bm_payx_payed',$insert,array("clientOrderId" => $params['tid']));							}						}					}					//--卡券结束					//企业支付开始					//$payed = pdo_fetch("SELECT * FROM ".tablename('bm_payx_payed')." WHERE rid = '$rid' and id='$iid'");					//$reply = pdo_fetch("SELECT * FROM ".tablename('bm_payx_reply')." WHERE rid = '$rid'");					//print_r('<pre>');print_r($payed);					//print_r('<pre>');print_r($reply);					if ($reply['payout']==1) {						$setting = uni_setting($_W['uniacid'], array('payment'));							//print('<pre>');print_r($setting);						$wechat = $setting['payment']['wechat'];										$url = 'https://api.mch.weixin.qq.com/mmpaymkttransfers/promotion/transfers';						$pars = array();						$pars['mch_appid'] = $_W['account']['key'];						$pars['mchid'] = $wechat['mchid'];						$pars['nonce_str'] = random(32);						$pars['partner_trade_no'] = random(10) . date('Ymd') . random(3);						$pars['openid'] = $reply['openid'];						$pars['check_name'] = "NO_CHECK";						$pars['re_user_name'] = "{$reply['title']}";						//$pars['amount'] = $payed['qrmoney']*100;						$pars['amount'] = $payed['qrmoney']*(100-$reply['payrate']);						//$pars['amount'] = 100;						$pars['desc'] = '扫码收款自动提现' . $payed['qrmoney'] . '元';						$pars['spbill_create_ip'] = '203.195.157.41';						ksort($pars, SORT_STRING);						$string1 = '';						foreach ($pars as $k => $v) {							$string1.= "{$k}={$v}&";						}						$string1.= "key=" . $wechat['apikey'];						$pars['sign'] = strtoupper(md5($string1));						//print_r('<pre>');print_r('|+$pars+|');print_r($pars);						$xml = '<xml>';						foreach ($pars as $k => $v) {							$xml.= "<{$k}>{$v}</{$k}>";						}						$xml.= '</xml>';						$extras = array();						$extras['CURLOPT_CAINFO']  = dirname(dirname(dirname(__FILE__))) . '/addons/bm_payx/cert/rootca.pem' . $_W['uniacid'];						$extras['CURLOPT_SSLCERT'] = dirname(dirname(dirname(__FILE__))) . '/addons/bm_payx/cert/apiclient_cert.pem' . $_W['uniacid'];						$extras['CURLOPT_SSLKEY']  = dirname(dirname(dirname(__FILE__))) . '/addons/bm_payx/cert/apiclient_key.pem' . $_W['uniacid'];						$procResult = null;						load()->func('communication');						$resp = ihttp_request($url, $xml, $extras);										if(is_error($resp)) {							$procResult = $resp;						} else {							$xml = '<?xml version="1.0" encoding="utf-8"?>' . $resp['content'];							$dom = new DOMDocument();							if($dom->loadXML($xml)) {								$xpath = new DOMXPath($dom);								$code = $xpath->evaluate('string(//xml/return_code)');								$ret = $xpath->evaluate('string(//xml/result_code)');								if(strtolower($code) == 'success' && strtolower($ret) == 'success') {									$procResult = true;								} else {									$error = $xpath->evaluate('string(//xml/err_code_des)');									$procResult = error(-2, $error);								}							} else {								$procResult = error(-1, 'error response');							}						}						//print_r('<pre>');print_r('|+支付结果+|');print_r($procResult);						$getmoney=$pars['amount']/100;						if ($procResult==1) {							pdo_update('bm_payx_payed',array("getmoney" => $getmoney,"getinfo" => 'success',"gettime" => TIMESTAMP,"getstatus"=>1),array("clientOrderId" => $params['tid']));						} else {							pdo_update('bm_payx_payed',array("getmoney" => $getmoney,"getinfo" => $procResult['message'],"gettime" => TIMESTAMP,"getstatus"=>0),array("clientOrderId" => $params['tid']));						}						//print_r('<pre>');print_r('OK');exit;					}					//企业支付结束					$fansuid =  pdo_fetchcolumn("select uid from " . tablename('mc_mapping_fans') . " where openid='{$payed['fromuser']}'");					if ($reply['ntype']==0) {						$credit1n=$reply['n'];					} else {						$credit1n=round($reply['n']*$payed['qrmoney']/100,0);					}					$updatememo = mc_credit_update($fansuid , 'credit1' , intval($credit1n) , array('0' => $fansuid, '1' => '扫码支付送积分' ));					$url=$_W['siteroot'].'app/'.$this->createMobileUrl('payok',array('cid' => $payed['clientOrderId']));					$template = array('touser' => $_W['fans']['openid'],								'template_id' => $reply['templateid1'],								//'url' => $_W['siteroot'].$this->createMobileUrl('index', array()),								'url' => $url,								'topcolor' => "#7B68EE",								'data' => array('first'	=> array('value' => urlencode('感谢您使用'.$_W['account']['name'].'扫码支付！'),																 'color' => "#743A3A",																  ),											  'keyword1' => array('value' => urlencode($payed['clientOrderId']),																 'color' => "#FF0000",																  ),											  'keyword2' 	=> array('value' => urlencode(date('Y-m-d H:i:s',time())),																 'color' => "#0000FF",																  ),											  'keyword3' 	=> array('value' => urlencode($payed['qrmoney']),																 'color' => "#0000FF",																  ),															  											  'remark' 	=> array('value' => urlencode("付款码：".$payed['paycode']."，点击详情查看账单！"),																 'color' => "#008000",																  ),											  )								);							$x=$this->send_template_message(urldecode(json_encode($template)),$access_token);																header("Location: " . $url);					exit;				} else {					$url=$_W['siteroot'].'app/'.$this->createMobileUrl('payok',array('cid' => $payed['clientOrderId']));					header("Location: " . $url);					exit;					//message($reply['qrerrormemo'],$reply['qrerrorurl'],'success');				}			}						//$msg='恭喜签到成功，您已获得奖励积分'.$reply['n'].'分，您目前的总积分为'.$user['credit1'].'分！';			//message($reply['memo'],$reply['urly'],'success');		}	}	public function doMobilePayok() {		global $_W,$_GPC;		$useragent = addslashes($_SERVER['HTTP_USER_AGENT']);        if (strpos($useragent, 'MicroMessenger') === false && strpos($useragent, 'Windows Phone') === false) {			message('非法访问，请通过微信打开！');			die();        }				$url=$_W['siteroot'].'app/'.$this->createMobileUrl('payok',array('rid' => $rid,'payid' => $payed['id']));		//print_r('<pre>');print_r($url);exit;		$cid = trim($_GPC['cid']);		$payed = pdo_fetch("SELECT * FROM " . tablename('bm_payx_payed') . " WHERE clientOrderId = :clientOrderId ORDER BY `id` DESC", array(':clientOrderId' => $cid));			$rid = trim($payed['rid']);		$reply = pdo_fetch("SELECT * FROM " . tablename('bm_payx_reply') . " WHERE rid = :rid ORDER BY `id` DESC", array(':rid' => $rid));			//print_r('<pre>');print_r($payed);exit;		include $this->template('payok');	}	public function doMobilePayed() {		global $_W,$_GPC;		$useragent = addslashes($_SERVER['HTTP_USER_AGENT']);        if (strpos($useragent, 'MicroMessenger') === false && strpos($useragent, 'Windows Phone') === false) {			message('非法访问，请通过微信打开！');			die();        }		$op = trim($_GPC['op']);		$url=$_W['siteroot'].'app/'.$this->createMobileUrl('payok',array('rid' => $rid,'payid' => $payed['id']));		//$cid = trim($_GPC['cid']);		//$payed = pdo_fetch("SELECT * FROM " . tablename('bm_payx_payed') . " WHERE clientOrderId = :clientOrderId ORDER BY `id` DESC", array(':clientOrderId' => $cid));			//$rid = trim($payed['rid']);		$rid = trim($_GPC['rid']);		$reply = pdo_fetch("SELECT * FROM " . tablename('bm_payx_reply') . " WHERE rid = :rid ORDER BY `id` DESC", array(':rid' => $rid));		if ($op=='detail') {			$day = trim($_GPC['day']);			if (!empty($day)) {				$condition=" and date_format(FROM_UNIXTIME(paytime),'%Y-%m-%d')='{$day}'";			} else {				$condition="";			}			$list = pdo_fetchall("SELECT * FROM " . tablename('bm_payx_payed') . " WHERE rid = :rid and status>0 $condition ORDER BY `id` DESC", array(':rid' => $rid));				//print_r('<pre>');print_r($day);print_r('<pre>');print_r($condition);print_r('<pre>');print_r($list);exit;			$totalsuccess = pdo_fetchcolumn("SELECT count(*) FROM " . tablename('bm_payx_payed') . " WHERE rid = :rid and status>0 $condition ORDER BY `id` DESC", array(':rid' => $rid));				$totalsuccessmoney = pdo_fetchcolumn("SELECT sum(qrmoney) FROM " . tablename('bm_payx_payed') . " WHERE rid = :rid and status>0 $condition ORDER BY `id` DESC", array(':rid' => $rid));			} elseif ($op=='day') {			$month = trim($_GPC['month']);			if (!empty($month)) {				$condition=" and date_format(FROM_UNIXTIME(paytime),'%Y-%m')='{$month}'";			} else {				$condition="";			}			$list = pdo_fetchall("SELECT date_format(FROM_UNIXTIME(paytime),'%Y-%m-%d') as day,count(*) as c,sum(qrmoney) as q,sum(red) as r FROM " . tablename('bm_payx_payed') . " WHERE rid = :rid and status>0 $condition group by day ORDER BY day", array(':rid' => $rid));				//print_r('<pre>');print_r($rid);print_r('<pre>');print_r($list);exit;			$totalsuccess = pdo_fetchcolumn("SELECT count(*) FROM " . tablename('bm_payx_payed') . " WHERE rid = :rid and status>0 $condition ORDER BY `id` DESC", array(':rid' => $rid));				$totalsuccessmoney = pdo_fetchcolumn("SELECT sum(qrmoney) FROM " . tablename('bm_payx_payed') . " WHERE rid = :rid and status>0 $condition ORDER BY `id` DESC", array(':rid' => $rid));			} elseif ($op=='month') {			$list = pdo_fetchall("SELECT date_format(FROM_UNIXTIME(paytime),'%Y-%m') as month,count(*) as c,sum(qrmoney) as q,sum(red) as r FROM " . tablename('bm_payx_payed') . " WHERE rid = :rid and status>0 group by month ORDER BY month", array(':rid' => $rid));				//print_r('<pre>');print_r($rid);print_r('<pre>');print_r($list);exit;			$totalsuccess = pdo_fetchcolumn("SELECT count(*) FROM " . tablename('bm_payx_payed') . " WHERE rid = :rid and status>0 ORDER BY `id` DESC", array(':rid' => $rid));				$totalsuccessmoney = pdo_fetchcolumn("SELECT sum(qrmoney) FROM " . tablename('bm_payx_payed') . " WHERE rid = :rid and status>0 ORDER BY `id` DESC", array(':rid' => $rid));			}				include $this->template('payed');	}	public function doMobilePaycheck() {		global $_W,$_GPC;		$useragent = addslashes($_SERVER['HTTP_USER_AGENT']);        if (strpos($useragent, 'MicroMessenger') === false && strpos($useragent, 'Windows Phone') === false) {			message('非法访问，请通过微信打开！');			die();        }			$cid = trim($_GPC['cid']);		//print_r($cid);exit;		$op = trim($_GPC['op']);		$payed = pdo_fetch("SELECT * FROM " . tablename('bm_payx_payed') . " WHERE clientOrderId = :clientOrderId ORDER BY `id` DESC", array(':clientOrderId' => $cid));			$rid = trim($payed['rid']);		$reply = pdo_fetch("SELECT * FROM " . tablename('bm_payx_reply') . " WHERE rid = :rid ORDER BY `id` DESC", array(':rid' => $rid));		if ($op=='used') {			//print_r('<pre>');print_r($cid);			//print_r('<pre>');print_r($op);exit;			$employee = pdo_fetch("SELECT * FROM " . tablename('bm_payx_employee') . " WHERE weid = :weid and from_user = :from_user ORDER BY `id` DESC", array(':weid' => $reply['weid'],':from_user' => $_W['fans']['openid']));			$insert = array(				'from_user' => $_W['fans']['openid'],				'eid' => $employee['id'],				'status' => 2,				'name' => $employee['name'],				'usetime' => TIMESTAMP,			);			pdo_update('bm_payx_payed',$insert,array("clientOrderId" => $cid));		} elseif ($op=='payed') {			$employee = pdo_fetch("SELECT * FROM " . tablename('bm_payx_employee') . " WHERE weid = :weid and from_user = :from_user ORDER BY `id` DESC", array(':weid' => $reply['weid'],':from_user' => $_W['fans']['openid']));						$insert = array(				'from_user' => $_W['fans']['openid'],				'eid' => $employee['id'],				'status' => 1,				'name' => $employee['name'],				'usetime' => TIMESTAMP,			);						//print_r('<pre>');print_r($cid);			//print_r('<pre>');print_r($op);exit;			pdo_update('bm_payx_payed',$insert,array("clientOrderId" => $cid));		}		$url=$_W['siteroot'].'app/'.$this->createMobileUrl('payok',array('rid' => $rid,'payid' => $payed['id']));		//print_r('<pre>');print_r($url);exit;		//$cid = trim($_GPC['cid']);		$cid = trim($_GPC['cid']);		//print_r($cid);exit;		$op = trim($_GPC['op']);		$payed = pdo_fetch("SELECT * FROM " . tablename('bm_payx_payed') . " WHERE clientOrderId = :clientOrderId ORDER BY `id` DESC", array(':clientOrderId' => $cid));			$rid = trim($payed['rid']);		$reply = pdo_fetch("SELECT * FROM " . tablename('bm_payx_reply') . " WHERE rid = :rid ORDER BY `id` DESC", array(':rid' => $rid));		//print_r('<pre>');print_r($payed);exit;		include $this->template('paycheck');	}		private function get_rand($proArr) {		$result = '';		//概率数组的总概率精度 		$proSum = array_sum($proArr);		//概率数组循环 		foreach ($proArr as $key => $proCur) {			$randNum = mt_rand(1, $proSum);			if ($randNum <= $proCur) {				$result = $key;				break;			} else {				$proSum -= $proCur;			}		}		unset ($proArr);		return $result;	}	}?><?php